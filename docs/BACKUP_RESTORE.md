# Backup & Restore for Azure App Service

This guide covers using HTTP-based scripts to backup and restore Tournament Allocator data on Azure App Service deployments.

## Overview

The backup/restore approach uses **HTTP API routes** (`/api/admin/export`, `/api/admin/import`) with API key authentication. This strategy is:

- **Simple** — no Azure CLI dependency, works from any machine with HTTP access
- **Secure** — API key authentication with timing-attack-safe comparison
- **Scriptable** — Python scripts for automated backups and restores
- **Safe** — validation ensures backup integrity before restore

Data lives in `/home/data` on Azure (persistent across deployments). The scripts access this data via HTTP routes secured with an API key.

## Architecture

### HTTP Routes
- **GET /api/admin/export** — Creates and downloads a ZIP archive of all tournament data
- **POST /api/admin/import** — Uploads and extracts a ZIP archive to restore data

### Security
- **Authentication**: API key via `Authorization: Bearer <key>` header
- **Key generation**: Auto-generated during deployment if not present
- **Key storage**: 
  - Azure App Settings (encrypted at rest)
  - Local `.env` file for script access
- **Comparison**: Timing-attack-safe using `hmac.compare_digest()`

### Key Generation
The `deploy.ps1` script automatically generates a 64-character hex API key (256-bit entropy) if `ADMIN_API_KEY` is not already set. The key is:
1. Stored in Azure App Settings as `ADMIN_API_KEY`
2. Written to local `.env` file for script usage
3. Never committed to source control (`.env` is in `.gitignore`)

## Prerequisites

### 1. Deploy the Application
Run the deployment script to set up the Azure App Service and generate the API key:
```bash
.\deploy.ps1
```

The deployment script will:
- Create or update Azure resources
- Auto-generate `ADMIN_API_KEY` if not present
- Store the key in Azure App Settings
- Write the key to local `.env` file

### 2. Verify API Key
After deployment, verify the `.env` file contains the API key:
```bash
# .env file should contain:
ADMIN_API_KEY=<64-character-hex-string>
```

If the file is missing or doesn't contain the key, run:
```bash
az webapp config appsettings list --name <app-name> --resource-group <resource-group> --query "[?name=='ADMIN_API_KEY'].value" -o tsv > .env.key
```

## Setup

### Initial Setup
1. **Deploy the application** (if not already deployed):
   ```bash
   .\deploy.ps1
   ```

2. **Verify API key** is stored in `.env`:
   ```bash
   cat .env | grep ADMIN_API_KEY
   ```

3. **Test the backup** to ensure everything is working:
   ```bash
   python scripts/backup.py
   ```

### Environment Configuration
The scripts read configuration from the `.env` file:

| Variable | Required | Description |
|----------|----------|-------------|
| `ADMIN_API_KEY` | Yes | API key for admin routes (auto-generated by deploy.ps1) |
| `AZURE_APP_NAME` | No | App Service name (can be passed as argument instead) |
| `AZURE_APP_URL` | No | Full app URL (derived from app name if not set) |

## Backup Script Usage

**Location**: `scripts/backup.py`

### Basic Backup

Create a timestamped backup in the local `backups/` directory:
```bash
python scripts/backup.py
```

The script reads `AZURE_APP_NAME` from `.env`. Output example:
```
Connecting to https://tournament-allocator-abc12345.azurewebsites.net...
Downloading backup from /api/admin/export...
Backup created successfully: backups/azure-backup-20260214-143022.zip (2.34 MB)
```

### Custom Output Path

Specify where to save the backup:
```bash
python scripts/backup.py --output /mnt/backup/my-backup.zip
```

### Specify App Name

If not in `.env` or to override:
```bash
python scripts/backup.py --app-name tournament-allocator-abc12345
```

### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Configuration error (missing API key or app name) |
| 2 | HTTP request failed (network, server error, or authentication) |
| 3 | Backup write failure (disk full, permissions, etc.) |

## Restore Script Usage

**Location**: `scripts/restore.py`

### Standard Restore

Restores a backup ZIP file to the Azure App Service:
```bash
python scripts/restore.py path/to/backup.zip
```

The script will:
1. Validate the ZIP file (must contain `tournaments.yaml`)
2. Upload the ZIP to `/api/admin/import`
3. Server extracts and validates the data
4. Report success or errors

Confirmation prompt:
```
⚠️  WARNING: This will replace all data on the App Service.
   Target: tournament-allocator-abc12345.azurewebsites.net

Type 'RESTORE' to continue:
```

Type `RESTORE` to proceed or any other text to cancel.

### Force Restore (skip confirmation)

For unattended/scripted restores:
```bash
python scripts/restore.py backup.zip --force
```

### Specify App Name

If not in `.env` or to override:
```bash
python scripts/restore.py backup.zip --app-name tournament-allocator-abc12345
```

### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | Invalid ZIP or missing configuration |
| 2 | HTTP request failed (authentication or server error) |
| 3 | Server-side validation failed |

## Common Scenarios

### 1. Disaster Recovery — Restore to Fresh Azure App Service

If the current App Service is corrupted, create a new one and restore data:

```bash
# 1. Deploy fresh app to new App Service (e.g., tournament-allocator-dr)
.\deploy.ps1  # Update AZURE_APP_NAME in .env first

# 2. Wait for deployment to complete
# 3. Restore from backup
python scripts/restore.py backups/azure-backup-20260214-143022.zip --force
```

### 2. Staging Clone — Create Testing Environment

Backup production, restore to staging:

```bash
# 1. Backup production
python scripts/backup.py --app-name tournament-allocator-prod --output backups/prod-clone.zip

# 2. Restore to staging (update AZURE_APP_NAME in .env first)
python scripts/restore.py backups/prod-clone.zip
```

### 3. Scheduled Automated Backups

Use local Task Scheduler (Windows) or cron (Linux/macOS) to run backups daily.

#### Windows Task Scheduler

1. Create a batch script `C:\scripts\backup-tournament.bat`:
```batch
@echo off
cd C:\Users\lucabol\dev\python-tournament-allocator
python scripts\backup.py
```

2. Open Task Scheduler, create a basic task:
   - **Trigger**: Daily at 02:00 (off-hours)
   - **Action**: Run `C:\scripts\backup-tournament.bat`
   - **Repeat**: Every day

#### Linux/macOS Cron

Add to crontab (`crontab -e`):
```cron
# Daily backup at 2 AM
0 2 * * * cd /home/user/tournament-allocator && python scripts/backup.py
```

#### Azure DevOps Pipeline

Store backups to Azure Blob Storage for long-term retention:

```yaml
trigger:
  schedule:
    - cron: "0 2 * * *"
      displayName: Daily backup at 2 AM UTC
      branches:
        include:
        - main

jobs:
  - job: BackupTournamentData
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.11'
      
      - script: |
          python scripts/backup.py --output $(Build.ArtifactStagingDirectory)/backup.zip
        displayName: 'Create backup'
        env:
          ADMIN_API_KEY: $(ADMIN_API_KEY)
          AZURE_APP_NAME: $(APP_NAME)
      
      - task: AzureCLI@2
        inputs:
          azureSubscription: $(AZURE_SUBSCRIPTION)
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            az storage blob upload \
              --account-name $(STORAGE_ACCOUNT) \
              --container-name backups \
              --name backup-$(date +%Y%m%d-%H%M%S).zip \
              --file $(Build.ArtifactStagingDirectory)/backup.zip
```

## Security Notes

### API Key Security
- **Key strength**: 64-character hex (256-bit entropy)
- **Storage**: Encrypted at rest in Azure App Settings
- **Comparison**: Uses `hmac.compare_digest()` to prevent timing attacks
- **Transport**: HTTPS only (Azure enforces TLS 1.2+)

### Best Practices

1. **Never commit `.env` file to source control**
   - The `.env` file contains the API key
   - Always verify `.gitignore` includes `.env`

2. **Rotate keys periodically**
   - Generate a new key: `python -c "import secrets; print(secrets.token_hex(32))"`
   - Update in Azure App Settings
   - Update in local `.env` file

3. **Store backups securely**
   - Keep local backups in encrypted storage or cloud backup service
   - Don't store backups in source control
   - Rotate old backups (e.g., keep only last 30 days)

4. **Test restores regularly**
   - Verify backups can be restored (don't just create them)
   - Test on staging before relying on production restores

5. **Monitor backup success**
   - Log backup output to a file: `python scripts/backup.py > backup.log 2>&1`
   - Set up alerts if scheduled backups fail
   - Check backup file sizes (sudden drops may indicate problems)

## Troubleshooting

### Error: "401 Unauthorized"
**Cause**: API key mismatch or missing.

**Solution**:
1. Verify `.env` file contains `ADMIN_API_KEY`
2. Check the key matches Azure App Settings:
   ```bash
   az webapp config appsettings list --name <app-name> --resource-group <resource-group> --query "[?name=='ADMIN_API_KEY'].value" -o tsv
   ```
3. If keys don't match, update `.env` with the correct key

### Error: "500 Server Error"
**Cause**: Server-side error during backup/restore.

**Solution**:
1. Check Azure App Service logs:
   ```bash
   az webapp log tail --name <app-name> --resource-group <resource-group>
   ```
2. Look for Python exceptions or disk space errors
3. Verify `/home/data` directory exists and is writable

### Error: "ZIP validation error: tournaments.yaml not found"
**Cause**: Backup ZIP is corrupted or from an incompatible version.

**Solution**: 
1. Create a fresh backup using the latest `backup.py`
2. Verify the ZIP contains `tournaments.yaml` at the root:
   ```bash
   unzip -l backup.zip | grep tournaments.yaml
   ```

### Error: "Connection timeout" or "Network error"
**Causes**:
- App Service is stopped or not responding
- Network connectivity issue
- Firewall blocking HTTPS

**Solution**:
1. Verify App Service is running:
   ```bash
   az webapp show --name <app-name> --resource-group <resource-group> --query state
   ```
2. Test HTTPS connectivity:
   ```bash
   curl -I https://<app-name>.azurewebsites.net
   ```
3. Check for firewall or proxy blocking HTTPS

### Error: "File too large" (on restore)
**Cause**: Backup ZIP exceeds Azure upload limits (rare).

**Solution**: 
- Azure App Service typically supports files up to 4 GB
- If your data exceeds this, consider manual data migration or contacting Azure support

## Migration from Azure CLI SSH Approach

**Prior approach** (deprecated): Azure CLI with SSH to App Service container.

**New approach** (HTTP-based): All backup/restore operations use HTTP API routes.

**Benefits**:
- No Azure CLI installation required
- Works from any machine with HTTP access
- Simpler authentication (API key vs. Azure login)
- Faster (no SSH overhead)
- More reliable (fewer network dependencies)

**For existing users transitioning to HTTP**:
1. Deploy the app with `deploy.ps1` (generates API key)
2. Verify `.env` contains `ADMIN_API_KEY`
3. Create a test backup using `scripts/backup.py`
4. Archive any backups created with the old CLI approach (they're still compatible)
5. Update automation scripts to use new HTTP-based scripts

## File Locations

| File | Purpose |
|------|---------|
| `scripts/backup.py` | Creates ZIP backup via HTTP GET |
| `scripts/restore.py` | Restores ZIP backup via HTTP POST |
| `backups/` | Local backup directory (created on first backup) |
| `.env` | API key and configuration (not in source control) |
| `/home/data` | App Service data directory (Azure only) |

## See Also

- [Azure App Service Documentation](https://learn.microsoft.com/en-us/azure/app-service/)
- [Tournament Allocator README](../README.md)
- [User Guide](../USER_GUIDE.md)
