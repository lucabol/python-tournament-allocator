{% extends "base.html" %}

{% block title %}Teams - Tournament Allocator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Team Management</h1>
    <div class="page-header-actions">
        {% if show_test_buttons %}<button type="button" class="btn btn-sm btn-secondary" onclick="loadTestTeams()">Test</button>{% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<section class="section registration-section">
    <div class="registration-header">
        <h2>Team Registration</h2>
        <div class="registration-controls">
            <button type="button" class="btn btn-sm btn-toggle {% if registrations.registration_open %}btn-toggle-on{% else %}btn-toggle-off{% endif %}" onclick="toggleRegistration()">
                {% if registrations.registration_open %}
                <span class="toggle-indicator">‚óè</span> Open
                {% else %}
                <span class="toggle-indicator">‚óã</span> Closed
                {% endif %}
            </button>
            <button type="button" class="btn btn-sm btn-primary" onclick="showUnpaidTeams()">
                üí∞ Unpaid Teams
            </button>
            <div id="qr-registration" style="display:inline-flex;flex-direction:column;align-items:center;gap:0.25rem;cursor:pointer;" onclick="copyRegistrationLink()" title="Click to copy registration link">
                <div id="qr-reg-container" style="background:#fff;padding:3px;border-radius:4px;line-height:0;"></div>
                <span style="font-size:0.7rem;color:var(--text-muted);">üìã Register</span>
            </div>
        </div>
    </div>
    <p class="registration-status">
        Status: <strong>{% if registrations.registration_open %}Open{% else %}Closed{% endif %}</strong> ‚Ä¢ 
        <span id="reg-count">{{ registrations.teams|length if registrations and registrations.teams else 0 }}</span> team(s) registered
    </p>
</section>

{% if registrations and registrations.teams %}
{% set unassigned_teams = registrations.teams | selectattr('status', 'equalto', 'unassigned') | list %}
{% if unassigned_teams %}
<section class="section">
    <h2>Unassigned Teams ({{ unassigned_teams|length }})</h2>
    <div class="unassigned-teams">
        {% for reg in unassigned_teams %}
        <div class="unassigned-team-card" draggable="true" data-team-name="{{ reg.team_name }}" data-team-email="{{ reg.email }}" data-team-phone="{{ reg.phone or '' }}">
            <div class="unassigned-team-header">
                <div class="unassigned-team-name">
                    <label class="paid-checkbox-label">
                        <input type="checkbox" class="paid-checkbox" 
                               id="paid-unreg-{{ reg.team_name | replace(' ', '_') }}"
                               name="paid-unreg-{{ reg.team_name | replace(' ', '_') }}"
                               autocomplete="off"
                               data-team-name="{{ reg.team_name }}"
                               onchange="togglePaid(this, '{{ reg.team_name }}')"
                               {% if reg.paid %}checked{% endif %}>
                        <span class="paid-indicator">üí∞</span>
                    </label>
                    {{ reg.team_name }}
                </div>
                <div class="unassigned-team-actions">
                    <button type="button" class="btn btn-xs btn-primary" onclick="editRegistration('{{ reg.team_name }}', '{{ reg.email }}', '{{ reg.phone or '' }}')">Edit</button>
                    <button type="button" class="btn btn-xs btn-danger" onclick="deleteRegistration('{{ reg.team_name }}')">Delete</button>
                </div>
            </div>
            <div class="unassigned-team-info">
                <div class="info-item">‚úâÔ∏è {{ reg.email }}</div>
                {% if reg.phone %}
                <div class="info-item">üìû {{ reg.phone }}</div>
                {% endif %}
                <div class="info-item">üìÖ {{ reg.registered_at[:10] if reg.registered_at else 'N/A' }}</div>
            </div>
            <div class="unassigned-team-assign">
                <label>Assign to pool:</label>
                <select class="assign-pool-select" onchange="assignToPool(this, '{{ reg.team_name }}')">
                    <option value="">Choose pool...</option>
                    {% for pool_name in pools.keys() %}
                    <option value="{{ pool_name }}">{{ pool_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
{% endif %}

<section class="section">
    <h2>Add New Pool</h2>
    <form method="POST" class="inline-form">
        <input type="hidden" name="action" value="add_pool">
        <input type="text" name="pool_name" placeholder="Pool name (e.g., Pool A)" required>
        <input type="number" name="advance_count" value="2" min="1" max="10" style="width: 80px;" title="Teams advancing">
        <span class="help-inline">advance</span>
        <button type="submit" class="btn btn-primary">Add Pool</button>
    </form>
</section>

{% if pools %}
<section class="section">
    <h2>Pools & Teams</h2>
    
    {% set paid_team_names = registrations.teams | selectattr('paid') | map(attribute='team_name') | list %}
    <div class="pools-grid">
        {% for pool_name, pool_data in pools.items() %}
        <div class="pool-card pool-drop-zone" data-pool-name="{{ pool_name }}">
            <div class="pool-header">
                <input type="text" value="{{ pool_name }}" class="pool-name-input" 
                       data-pool-name="{{ pool_name }}"
                       onchange="savePoolName(this, '{{ pool_name }}')">
                <form method="POST" class="inline" onsubmit="return confirm('Delete this pool and all its teams?');">
                    <input type="hidden" name="action" value="delete_pool">
                    <input type="hidden" name="pool_name" value="{{ pool_name }}">
                    <button type="submit" class="btn btn-danger btn-sm">Delete Pool</button>
                </form>
            </div>
            
            <div class="advance-setting">
                <label>Top</label>
                <input type="number" value="{{ pool_data.advance }}" min="1" max="10" style="width: 60px;"
                       onchange="saveAdvance(this, '{{ pool_name }}')">
                <label>advance</label>
            </div>
            
            {% if pool_data.teams %}
            <ul class="team-list">
                {% for team in pool_data.teams %}
                <li>
                    <div class="team-item-wrapper">
                        <label class="paid-checkbox-label">
                            <input type="checkbox" class="paid-checkbox" 
                                   id="paid-pool-{{ team | replace(' ', '_') }}"
                                   name="paid-pool-{{ team | replace(' ', '_') }}"
                                   autocomplete="off"
                                   data-team-name="{{ team }}"
                                   onchange="togglePaid(this, '{{ team }}')"
                                   {% if team in paid_team_names %}checked{% endif %}>
                            <span class="paid-indicator">üí∞</span>
                        </label>
                        <input type="text" value="{{ team }}" class="team-name-input"
                               onchange="saveTeamName(this, '{{ pool_name }}', '{{ team }}')">
                    </div>
                    <form method="POST" class="inline">
                        <input type="hidden" name="action" value="delete_team">
                        <input type="hidden" name="pool_name" value="{{ pool_name }}">
                        <input type="hidden" name="team_name" value="{{ team }}">
                        <button type="submit" class="btn btn-danger btn-xs">√ó</button>
                    </form>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="empty-message">No teams in this pool yet.</p>
            {% endif %}
            
            <p class="pool-stats">
                {{ pool_data.teams|length }} team(s) ‚Ä¢ 
                {{ (pool_data.teams|length * (pool_data.teams|length - 1)) // 2 }} match(es) ‚Ä¢
                Top {{ pool_data.advance }} advance
            </p>
        </div>
        {% endfor %}
    </div>
</section>
{% else %}
<div class="empty-state">
    <h2>No pools yet</h2>
    <p>Create a pool above to get started.</p>
</div>
{% endif %}

<section class="section">
    <h2>Import / Export 
        <span class="help-icon" onclick="document.getElementById('teams-yaml-help').style.display='flex'">?</span>
    </h2>
    <form method="POST" enctype="multipart/form-data" class="inline-form" id="teams-yaml-form" style="display: inline;">
        <input type="hidden" name="action" value="load_yaml">
        <input type="file" name="yaml_file" accept=".yaml,.yml" required style="display:none" id="teams-yaml-input" onchange="document.getElementById('teams-yaml-form').submit()">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('teams-yaml-input').click()">Import Teams</button>
    </form>
    <button type="button" class="btn btn-primary" onclick="exportTeams()" style="margin-left: 10px;">Export Teams</button>
    <p class="help-text">Importing will replace all existing teams and clear the schedule.</p>
</section>

<div id="teams-yaml-help" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Teams YAML Format</h3>
            <button class="modal-close" onclick="document.getElementById('teams-yaml-help').style.display='none'">&times;</button>
        </div>
        <pre id="teams-yaml-example">Pool A:
  teams:
    - name: "Team 1"
      email: "team1@example.com"
      phone: "555-1234"
    - name: "Team 2"
      email: "team2@example.com"
  advance: 2

Pool B:
  teams:
    - Team 3
    - Team 4
  advance: 2

# Or simple format:
Pool A:
  - name: "Team 1"
    email: "team1@example.com"
    phone: "555-1234"
  - Team 2</pre>
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.getElementById('teams-yaml-example').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy to Clipboard',2000)">Copy to Clipboard</button>
    </div>
</div>

<div id="unpaid-teams-modal" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Unpaid Teams</h3>
            <button class="modal-close" onclick="document.getElementById('unpaid-teams-modal').style.display='none'">&times;</button>
        </div>
        <div id="unpaid-teams-list" class="unpaid-teams-list">
            <p class="loading-message">Loading...</p>
        </div>
    </div>
</div>

<script>
// Registration toggle
async function toggleRegistration() {
    try {
        const response = await fetch('{{ url_for("api_toggle_registration") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        if (result.success) {
            location.reload();
        } else {
            alert(`Failed to toggle registration: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Toggle registration error:', error);
        alert(`Error toggling registration: ${error.message}`);
    }
}

// Copy registration link
function copyRegistrationLink() {
    const username = '{{ current_user }}';
    const slug = '{{ active_tournament }}';
    const url = window.location.origin + `/register/${username}/${slug}`;
    navigator.clipboard.writeText(url).then(() => {
        alert('Registration link copied to clipboard!');
    });
}

// Edit registration
async function editRegistration(teamName, email, phone) {
    const newName = prompt('Team name:', teamName);
    if (!newName || newName === teamName) return;
    
    const newEmail = prompt('Email:', email);
    if (!newEmail) return;
    
    const newPhone = prompt('Phone (optional):', phone);
    
    const response = await fetch('{{ url_for("api_edit_registration") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            old_team_name: teamName,
            team_name: newName,
            email: newEmail,
            phone: newPhone
        })
    });
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.error || 'Edit failed');
    }
}

// Delete registration
async function deleteRegistration(teamName) {
    if (!confirm(`Delete registration for "${teamName}"?`)) return;
    
    const response = await fetch('{{ url_for("api_delete_registration") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({team_name: teamName})
    });
    const result = await response.json();
    if (result.success) {
        location.reload();
    }
}

// Assign to pool (from dropdown)
async function assignToPool(select, teamName) {
    const poolName = select.value;
    if (!poolName) return;
    
    const response = await fetch('{{ url_for("api_assign_from_registration") }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({team_name: teamName, pool_name: poolName})
    });
    const result = await response.json();
    if (result.success) {
        location.reload();
    } else {
        alert(result.error || 'Assignment failed');
        select.value = '';
    }
}

// Drag and drop
document.addEventListener('DOMContentLoaded', function() {
    // Initialize QR code for registration link
    const username = '{{ current_user }}';
    const slug = '{{ active_tournament }}';
    const regUrl = window.location.origin + `/register/${username}/${slug}`;
    const qrContainer = document.getElementById('qr-reg-container');
    
    if (qrContainer && typeof QRCode !== 'undefined') {
        new QRCode(qrContainer, {
            text: regUrl,
            width: 80,
            height: 80,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
        });
    }
    
    let draggedTeam = null;
    
    // Make unassigned teams draggable
    document.querySelectorAll('.unassigned-team-card').forEach(card => {
        card.addEventListener('dragstart', function(e) {
            draggedTeam = {
                name: this.dataset.teamName,
                email: this.dataset.teamEmail,
                phone: this.dataset.teamPhone
            };
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        
        card.addEventListener('dragend', function() {
            this.classList.remove('dragging');
            draggedTeam = null;
        });
    });
    
    // Make pool cards drop zones
    document.querySelectorAll('.pool-drop-zone').forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', async function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (!draggedTeam) return;
            
            const poolName = this.dataset.poolName;
            const response = await fetch('{{ url_for("api_assign_from_registration") }}', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({team_name: draggedTeam.name, pool_name: poolName})
            });
            
            const result = await response.json();
            if (result.success) {
                location.reload();
            } else {
                alert(result.error || 'Drop failed');
            }
        });
    });
});

// Existing functions
async function savePoolName(input, oldName) {
    const newName = input.value.trim();
    if (newName === oldName) return;
    
    const response = await fetch('/api/teams/edit_pool', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({old_name: oldName, new_name: newName})
    });
    const result = await response.json();
    if (!result.success) {
        alert(result.error);
        input.value = oldName;
    } else {
        // Update data attributes for future edits
        input.dataset.poolName = newName;
        input.setAttribute('onchange', `savePoolName(this, '${newName}')`);
    }
}

async function saveTeamName(input, poolName, oldName) {
    const newName = input.value.trim();
    if (newName === oldName) return;
    
    const response = await fetch('/api/teams/edit_team', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pool_name: poolName, old_name: oldName, new_name: newName})
    });
    const result = await response.json();
    if (!result.success) {
        alert(result.error);
        input.value = oldName;
    } else {
        input.setAttribute('onchange', `saveTeamName(this, '${poolName}', '${newName}')`);
    }
}

async function saveAdvance(input, poolName) {
    const value = parseInt(input.value);
    await fetch('/api/teams/update_advance', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({pool_name: poolName, advance_count: value})
    });
}

function loadTestTeams() {
    fetch('/api/test-teams', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// Export teams
async function exportTeams() {
    try {
        const response = await fetch('/api/export-teams', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'teams.yaml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        console.error('Export error:', error);
        alert(`Error exporting teams: ${error.message}`);
    }
}

// Toggle paid status
async function togglePaid(checkbox, teamName) {
    try {
        const response = await fetch('/api/toggle-paid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({team_name: teamName})
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        if (!result.success) {
            alert(result.error || 'Failed to toggle paid status');
            checkbox.checked = !checkbox.checked; // Revert
        }
    } catch (error) {
        console.error('Toggle paid error:', error);
        alert(`Error toggling paid status: ${error.message}`);
        checkbox.checked = !checkbox.checked; // Revert
    }
}

// Show unpaid teams overlay
async function showUnpaidTeams() {
    const modal = document.getElementById('unpaid-teams-modal');
    const listContainer = document.getElementById('unpaid-teams-list');
    
    modal.style.display = 'flex';
    listContainer.innerHTML = '<p class="loading-message">Loading...</p>';
    
    try {
        const response = await fetch('/api/unpaid-teams', {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (!result.success) {
            listContainer.innerHTML = `<p class="error-message">${result.error || 'Failed to load unpaid teams'}</p>`;
            return;
        }
        
        if (!result.unpaid_teams || result.unpaid_teams.length === 0) {
            listContainer.innerHTML = '<p class="success-message">‚úÖ All teams have paid!</p>';
            return;
        }
        
        // Build the list
        let html = '<div class="unpaid-teams-grid">';
        result.unpaid_teams.forEach(team => {
            html += `
                <div class="unpaid-team-item">
                    <div class="unpaid-team-name">üèê ${team.team_name}</div>
                    <div class="unpaid-team-email">‚úâÔ∏è ${team.email || 'No email'}</div>
                </div>
            `;
        });
        html += '</div>';
        
        listContainer.innerHTML = html;
    } catch (error) {
        console.error('Show unpaid teams error:', error);
        listContainer.innerHTML = `<p class="error-message">Error loading unpaid teams: ${error.message}</p>`;
    }
}
</script>
{% endblock %}
