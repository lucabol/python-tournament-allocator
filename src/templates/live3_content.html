{# Live3 Content: Responsive Table Reflow
   â€” Keeps table structure but uses data-label attributes for CSS reflow on mobile #}

{% if not pools %}
<div class="empty-state">
    <h2>Tournament Not Started</h2>
    <p>No teams have been configured yet.</p>
</div>
{% else %}

{# --- Champion Banners --- #}
{% if bracket_data and bracket_data.champion %}
<div class="champion-banner">ğŸ† Gold Champion: <strong>{{ bracket_data.champion }}</strong></div>
{% endif %}
{% if silver_bracket_data and silver_bracket_data.champion %}
<div class="champion-banner silver-champion">ğŸ¥ˆ Silver Champion: <strong>{{ silver_bracket_data.champion }}</strong></div>
{% endif %}

{# ============ SCHEDULE â€” POOL PLAY ============ #}
{% if schedule %}
{% set pool_days = schedule.keys() | reject('equalto', 'Bracket Phase') | list %}
{% if pool_days %}
<h2 class="section-header">ğŸ“… Schedule</h2>
{% for day in pool_days %}
{% set day_data = schedule[day] %}
<h3 class="day-header">{{ day }}</h3>

{% set time_slots = day_data['_time_slots'] %}
{% set courts = day_data.keys() | reject('equalto', '_time_slots') | list %}

<table class="reflow-table">
    <thead>
        <tr>
            <th>Time</th>
            {% for court_name in courts %}
            <th>{{ court_name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for time_slot in time_slots %}
        <tr data-teams="{% for court_name in courts %}{% if time_slot in day_data[court_name]['time_to_match'] %}{{ day_data[court_name]['time_to_match'][time_slot].teams[0] }} {{ day_data[court_name]['time_to_match'][time_slot].teams[1] }} {% endif %}{% endfor %}">
            <td class="time-cell" data-label="Time">{{ time_slot }}</td>
            {% for court_name in courts %}
            <td data-label="{{ court_name }}">
                {% if time_slot in day_data[court_name]['time_to_match'] %}
                {% set match = day_data[court_name]['time_to_match'][time_slot] %}
                {% set team1 = match.teams[0] %}
                {% set team2 = match.teams[1] %}
                {% set match_key_check = [team1, team2]|sort|join('_vs_') %}
                {% set pool_name = match.pool if match.pool else '' %}
                {% set full_match_key = match_key_check ~ '_' ~ pool_name if pool_name else match_key_check %}
                {% set match_result = results.get(full_match_key, {}) %}
                {% set is_completed = match_result.get('completed', false) %}
                <div class="match-cell-reflow {% if is_completed %}match-completed{% endif %}">
                    <div class="match-row">
                        <span class="team-name {% if match_result.winner == team1 %}winner{% endif %}">{{ team1 }}</span>
                        {% if match_result.sets %}
                        <span class="cell-score">{{ match_result.sets[0][0] if match_result.sets[0] else '-' }}</span>
                        {% endif %}
                    </div>
                    <div class="match-row">
                        <span class="team-name {% if match_result.winner == team2 %}winner{% endif %}">{{ team2 }}</span>
                        {% if match_result.sets %}
                        <span class="cell-score">{{ match_result.sets[0][1] if match_result.sets[0] else '-' }}</span>
                        {% endif %}
                    </div>
                    {% if pool_name %}<div class="cell-pool">{{ pool_name }}</div>{% endif %}
                </div>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endfor %}
{% endif %}
{% endif %}

{# ============ POOL STANDINGS ============ #}
<h2 class="section-header">ğŸ“Š Pool Standings</h2>
{% if standings %}
<div class="standings-grid">
{% for pool_name, team_list in standings.items() %}
<div class="standings-reflow" data-teams="{{ team_list | map(attribute='team') | join(' ') }}">
    <h3>{{ pool_name }}</h3>
    <table class="reflow-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Team</th>
                <th>W</th>
                <th>L</th>
                <th>Sets</th>
                <th>Î” Sets</th>
                <th class="col-delta-pts">Î” Pts</th>
            </tr>
        </thead>
        <tbody>
            {% for team in team_list %}
            {% set advance_count = pools[pool_name].advance if pools and pool_name in pools else 2 %}
            {% set has_played = team.matches_played > 0 %}
            <tr class="{% if loop.index <= advance_count and has_played %}advancing{% endif %}">
                <td data-label="#">{{ loop.index }}</td>
                <td data-label="Team" style="font-weight:700;">{{ team.team }}</td>
                <td data-label="W">{{ team.wins }}</td>
                <td data-label="L">{{ team.losses }}</td>
                <td data-label="Sets">{{ team.sets_won }}-{{ team.sets_lost }}</td>
                <td data-label="Î” Sets" class="{% if team.set_diff > 0 %}positive{% elif team.set_diff < 0 %}negative{% endif %}">
                    {{ '+' if team.set_diff > 0 else '' }}{{ team.set_diff }}
                </td>
                <td data-label="Î” Pts" class="col-delta-pts {% if team.point_diff > 0 %}positive{% elif team.point_diff < 0 %}negative{% endif %}">
                    {{ '+' if team.point_diff > 0 else '' }}{{ team.point_diff }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}
</div>
{% else %}
<p class="empty-note">No pool results recorded yet.</p>
{% endif %}

{# ============ BRACKET PHASE SCHEDULE ============ #}
{% if schedule and 'Bracket Phase' in schedule %}
<h2 class="section-header">ğŸ“… Bracket Schedule</h2>
{% set bracket_day_data = schedule['Bracket Phase'] %}
{% set bracket_time_slots = bracket_day_data['_time_slots'] %}
{% set bracket_courts = bracket_day_data.keys() | reject('equalto', '_time_slots') | list %}

<table class="reflow-table">
    <thead>
        <tr>
            <th>Time</th>
            {% for court_name in bracket_courts %}
            <th>{{ court_name }}</th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        {% for time_slot in bracket_time_slots %}
        <tr data-teams="{% for court_name in bracket_courts %}{% if time_slot in bracket_day_data[court_name]['time_to_match'] %}{{ bracket_day_data[court_name]['time_to_match'][time_slot].teams[0] }} {{ bracket_day_data[court_name]['time_to_match'][time_slot].teams[1] }} {% endif %}{% endfor %}">
            <td class="time-cell" data-label="Time">{{ time_slot }}</td>
            {% for court_name in bracket_courts %}
            <td data-label="{{ court_name }}">
                {% if time_slot in bracket_day_data[court_name]['time_to_match'] %}
                {% set match = bracket_day_data[court_name]['time_to_match'][time_slot] %}
                {% set team1 = match.teams[0] %}
                {% set team2 = match.teams[1] %}
                {% set match_result = match.get('result', {}) %}
                {% set is_completed = match_result.get('completed', false) %}
                <div class="match-cell-reflow {% if is_completed %}match-completed{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %}">
                    <div class="match-row">
                        <span class="team-name {% if match_result.winner == team1 %}winner{% endif %}">{{ team1 }}</span>
                        {% if match_result.sets %}
                        <span class="cell-score">{{ match_result.sets[0][0] if match_result.sets[0] else '-' }}</span>
                        {% endif %}
                    </div>
                    <div class="match-row">
                        <span class="team-name {% if match_result.winner == team2 %}winner{% endif %}">{{ team2 }}</span>
                        {% if match_result.sets %}
                        <span class="cell-score">{{ match_result.sets[0][1] if match_result.sets[0] else '-' }}</span>
                        {% endif %}
                    </div>
                    {% if match.round %}<div class="cell-pool">{{ match.round }}</div>{% endif %}
                </div>
                {% endif %}
            </td>
            {% endfor %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

{# ============ BRACKETS ============ #}
{% if bracket_data %}
<h2 class="section-header">ğŸ¥‡ Gold Bracket</h2>

<h3 class="bracket-sub-header">ğŸ”µ Winners Bracket</h3>
{% for round_name, matches in bracket_data.winners_bracket.items() %}
<div class="bracket-round-label">{{ round_name }}</div>
{% for match in matches %}
<div class="bracket-match-reflow {% if match.is_bye %}bye-match{% endif %} {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
    <div class="bracket-match-meta">
        <span>{{ match.match_code }}</span>
        {% if match.get('winner') and not match.is_bye %}<span>âœ“</span>
        {% elif match.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
            {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
        </span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
            {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
        </span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
    {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
</div>
{% endfor %}
{% endfor %}

{% if bracket_data.losers_bracket %}
<h3 class="bracket-sub-header">ğŸ”´ Losers Bracket</h3>
{% for round_name, matches in bracket_data.losers_bracket.items() %}
<div class="bracket-round-label">{{ round_name }}</div>
{% for match in matches %}
<div class="bracket-match-reflow {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('winner') %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
    <div class="bracket-match-meta">
        <span>{{ match.match_code }}</span>
        {% if match.get('winner') %}<span>âœ“</span>
        {% elif match.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endfor %}
{% endif %}

{% if bracket_data.grand_final %}
<h3 class="bracket-sub-header">ğŸ† Grand Final</h3>
<div class="bracket-match-reflow grand-final-match {% if bracket_data.grand_final.get('winner') %}match-completed{% endif %}" data-teams="{{ bracket_data.grand_final.teams[0] }} {{ bracket_data.grand_final.teams[1] }}">
    <div class="bracket-match-meta">
        <span>Grand Final</span>
        {% if bracket_data.grand_final.get('winner') %}<span>âœ“</span>
        {% elif bracket_data.grand_final.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[0] %}winner{% endif %}">{{ bracket_data.grand_final.teams[0] }}</span>
        {% if bracket_data.grand_final.result and bracket_data.grand_final.result.sets %}
        <span class="bracket-score">{{ bracket_data.grand_final.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[1] %}winner{% endif %}">{{ bracket_data.grand_final.teams[1] }}</span>
        {% if bracket_data.grand_final.result and bracket_data.grand_final.result.sets %}
        <span class="bracket-score">{{ bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>

{% if bracket_data.bracket_reset and bracket_data.bracket_reset.get('needs_reset') %}
<div class="bracket-match-reflow grand-final-match {% if bracket_data.bracket_reset.get('winner') %}match-completed{% endif %}" data-teams="{{ bracket_data.bracket_reset.teams[0] }} {{ bracket_data.bracket_reset.teams[1] }}">
    <div class="bracket-match-meta">
        <span>Bracket Reset</span>
        {% if bracket_data.bracket_reset.get('winner') %}<span>âœ“</span>
        {% elif bracket_data.bracket_reset.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[0] %}winner{% endif %}">{{ bracket_data.bracket_reset.teams[0] }}</span>
        {% if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets %}
        <span class="bracket-score">{{ bracket_data.bracket_reset.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[1] %}winner{% endif %}">{{ bracket_data.bracket_reset.teams[1] }}</span>
        {% if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets %}
        <span class="bracket-score">{{ bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}
{% endif %}

{# ============ SILVER BRACKET ============ #}
{% if silver_bracket_enabled and silver_bracket_data %}
<h2 class="section-header">ğŸ¥ˆ Silver Bracket</h2>

<h3 class="bracket-sub-header">ğŸ¥ˆ Winners Bracket</h3>
{% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
<div class="bracket-round-label">{{ round_name }}</div>
{% for match in matches %}
<div class="bracket-match-reflow {% if match.is_bye %}bye-match{% endif %} {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
    <div class="bracket-match-meta">
        <span>{{ match.match_code }}</span>
        {% if match.get('winner') and not match.is_bye %}<span>âœ“</span>
        {% elif match.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
            {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
        </span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
            {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
        </span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
    {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
</div>
{% endfor %}
{% endfor %}

{% if silver_bracket_data.losers_bracket %}
<h3 class="bracket-sub-header">ğŸ¥ˆ Losers Bracket</h3>
{% for round_name, matches in silver_bracket_data.losers_bracket.items() %}
<div class="bracket-round-label">{{ round_name }}</div>
{% for match in matches %}
<div class="bracket-match-reflow {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('winner') %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
    <div class="bracket-match-meta">
        <span>{{ match.match_code }}</span>
        {% if match.get('winner') %}<span>âœ“</span>
        {% elif match.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
        {% if match.result and match.result.sets %}
        <span class="bracket-score">{{ match.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>
{% endfor %}
{% endfor %}
{% endif %}

{% if silver_bracket_data.grand_final %}
<h3 class="bracket-sub-header">ğŸ¥ˆ Silver Grand Final</h3>
<div class="bracket-match-reflow grand-final-match {% if silver_bracket_data.grand_final.get('winner') %}match-completed{% endif %}" data-teams="{{ silver_bracket_data.grand_final.teams[0] }} {{ silver_bracket_data.grand_final.teams[1] }}">
    <div class="bracket-match-meta">
        <span>Silver Grand Final</span>
        {% if silver_bracket_data.grand_final.get('winner') %}<span>âœ“</span>
        {% elif silver_bracket_data.grand_final.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[0] %}winner{% endif %}">{{ silver_bracket_data.grand_final.teams[0] }}</span>
        {% if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets %}
        <span class="bracket-score">{{ silver_bracket_data.grand_final.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[1] %}winner{% endif %}">{{ silver_bracket_data.grand_final.teams[1] }}</span>
        {% if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets %}
        <span class="bracket-score">{{ silver_bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>

{% if silver_bracket_data.bracket_reset and silver_bracket_data.bracket_reset.get('needs_reset') %}
<div class="bracket-match-reflow grand-final-match {% if silver_bracket_data.bracket_reset.get('winner') %}match-completed{% endif %}" data-teams="{{ silver_bracket_data.bracket_reset.teams[0] }} {{ silver_bracket_data.bracket_reset.teams[1] }}">
    <div class="bracket-match-meta">
        <span>Silver Bracket Reset</span>
        {% if silver_bracket_data.bracket_reset.get('winner') %}<span>âœ“</span>
        {% elif silver_bracket_data.bracket_reset.get('is_playable') %}<span>ğŸŸ¢</span>{% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[0] %}winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[0] }}</span>
        {% if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets %}
        <span class="bracket-score">{{ silver_bracket_data.bracket_reset.result.sets | map('first') | join('-') }}</span>
        {% endif %}
    </div>
    <div class="bracket-match-row">
        <span class="team-name {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[1] %}winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[1] }}</span>
        {% if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets %}
        <span class="bracket-score">{{ silver_bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
        {% endif %}
    </div>
</div>
{% endif %}
{% endif %}
{% endif %}

{% endif %}{# end pools #}
