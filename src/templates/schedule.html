{% extends "base.html" %}

{% block title %}Schedule - Tournament Allocator{% endblock %}

{% block content %}
<h1>Tournament Schedule</h1>

<section class="section">
    <form method="POST" onsubmit="this.querySelector('.btn-with-spinner').classList.add('loading')">
        <button type="submit" class="btn btn-success btn-lg btn-with-spinner">
            <span>ðŸ”„ Generate Schedule</span>
            <span class="spinner"></span>
        </button>
    </form>
</section>

{% if error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if stats %}
<div class="stats-bar">
    <div class="stat">
        <span class="stat-value">{{ stats.total_matches }}</span>
        <span class="stat-label">Total Matches</span>
    </div>
    <div class="stat">
        <span class="stat-value success">{{ stats.scheduled_matches }}</span>
        <span class="stat-label">Scheduled</span>
    </div>
    {% if stats.unscheduled_matches > 0 %}
    <div class="stat">
        <span class="stat-value danger">{{ stats.unscheduled_matches }}</span>
        <span class="stat-label">Unscheduled</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% if schedule %}
    {% set sorted_days = schedule.keys() | sort | list %}
    {% set bracket_phase = 'Bracket Phase' %}
    {% if bracket_phase in sorted_days %}
        {% set pool_days = sorted_days | reject('equalto', bracket_phase) | list %}
        {% set sorted_days = pool_days + [bracket_phase] %}
    {% endif %}
    {% for day in sorted_days %}
    {% set day_data = schedule[day] %}
    {% set time_slots = day_data['_time_slots'] if '_time_slots' in day_data else [] %}
    {% set courts = day_data.keys() | reject('equalto', '_time_slots') | list %}

    {# --- Desktop: table layout --- #}
    <section class="section day-section desktop-only">
        <h2>{{ day }}</h2>
        <div class="schedule-table-wrapper">
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th class="time-col">Time</th>
                        {% for court_name in courts %}
                        <th>{{ court_name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for time_slot in time_slots %}
                    <tr>
                        <td class="time-col">{{ time_slot }}</td>
                        {% for court_name in courts %}
                        <td>
                            {% set court_data = day_data[court_name] %}
                            {% set time_to_match = court_data.time_to_match if court_data.time_to_match is defined else {} %}
                            {% if time_slot in time_to_match %}
                                {% set match = time_to_match[time_slot] %}
                                {% set has_result = match.result is defined and match.result and match.result.completed %}
                                <div class="match-cell {% if match.is_bracket %}bracket-match{% endif %} {% if match.is_placeholder %}placeholder-match{% endif %} {% if has_result %}completed-match{% endif %}">
                                    {% if match.match_code %}
                                    <span class="match-code-badge">{{ match.match_code }}</span>
                                    {% endif %}
                                    <span class="match-teams {% if match.is_placeholder %}placeholder{% endif %}">
                                        {% if has_result %}
                                            <span class="{% if match.result.winner == match.teams[0] %}winner{% else %}loser{% endif %}">{{ match.teams[0] }}</span>
                                            <span class="vs">vs</span>
                                            <span class="{% if match.result.winner == match.teams[1] %}winner{% else %}loser{% endif %}">{{ match.teams[1] }}</span>
                                        {% else %}
                                            {{ match.teams[0] }} <span class="vs">vs</span> {{ match.teams[1] }}
                                        {% endif %}
                                    </span>
                                    {% if has_result and match.result.sets %}
                                    <div class="match-score">
                                        {% for set in match.result.sets %}
                                            <span class="set-score">{{ set[0] }}-{{ set[1] }}</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    {% if match.is_bracket %}
                                    <div class="match-round">{{ match.round }}</div>
                                    {% elif match.pool %}
                                    <div class="match-pool">{{ match.pool }}</div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

    {# --- Mobile: accordion + flat list --- #}
    <details class="m-drill-down mobile-only" open>
        <summary>{{ day }}</summary>
        <div class="m-drill-down-content">
            {% for time_slot in time_slots %}
            {% for court_name in courts %}
            {% set court_data = day_data[court_name] %}
            {% set time_to_match = court_data.time_to_match if court_data.time_to_match is defined else {} %}
            {% if time_slot in time_to_match %}
                {% set match = time_to_match[time_slot] %}
                {% set has_result = match.result is defined and match.result and match.result.completed %}
                <div class="m-match-item {% if has_result %}match-completed{% endif %} {% if match.is_bracket %}m-bracket-match{% endif %} {% if match.is_placeholder %}m-placeholder{% endif %}">
                    <div class="m-match-meta">
                        <span>{{ time_slot }} Â· {{ court_name }}</span>
                        {% if match.match_code %}<span class="m-match-code">{{ match.match_code }}</span>{% endif %}
                        {% if match.is_bracket %}<span>{{ match.round }}</span>
                        {% elif match.pool %}<span>{{ match.pool }}</span>{% endif %}
                    </div>
                    <div class="m-match-row">
                        <span class="team-name {% if has_result and match.result.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
                        {% if has_result and match.result.sets %}
                        <span class="m-score">{{ match.result.sets | map('first') | join('-') }}</span>
                        {% endif %}
                    </div>
                    <div class="m-match-row">
                        <span class="team-name {% if has_result and match.result.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
                        {% if has_result and match.result.sets %}
                        <span class="m-score">{{ match.result.sets | map('last') | join('-') }}</span>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </details>
    {% endfor %}
{% elif not error %}
<div class="empty-state">
    <h2>No schedule generated yet</h2>
    <p>Click "Generate Schedule" to create the tournament schedule based on your teams, courts, and constraints.</p>
</div>
{% endif %}
{% endblock %}
