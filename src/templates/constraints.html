{% extends "base.html" %}

{% block title %}Settings - Tournament Allocator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Tournament Settings</h1>
</div>

<section class="section">
    <h2>General Settings</h2>
    <div class="form-card">
        <div class="form-grid">
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Logo</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <img id="logo-preview" src="/api/logo" alt="Logo" style="height: 50px; width: auto; border: 1px solid #e5e7eb; border-radius: 4px; padding: 4px;">
                    <label class="btn btn-success btn-sm" style="cursor: pointer; margin: 0;">
                        Upload Logo
                        <input type="file" id="logo_upload" accept="image/*" style="display: none;" onchange="uploadLogo(this)">
                    </label>
                </div>
            </div>
            
            <div class="form-group">
                <label for="club_name">Club Name</label>
                <input type="text" id="club_name" name="club_name" 
                       value="{{ constraints.club_name | default('') }}" placeholder="e.g. Montg√≥ Beach Volley Club"
                       onchange="updateSetting('club_name', this.value)">
            </div>
            
            <div class="form-group">
                <label for="tournament_name">Tournament Name</label>
                <input type="text" id="tournament_name" name="tournament_name" 
                       value="{{ constraints.tournament_name | default('') }}" placeholder="e.g. Summer Tournament 2026"
                       onchange="updateSetting('tournament_name', this.value)">
            </div>
            
            <div class="form-group">
                <label for="tournament_date">Date</label>
                <input type="text" id="tournament_date" name="tournament_date" 
                       value="{{ constraints.tournament_date | default('') }}" placeholder="e.g. July 2026"
                       onchange="updateSetting('tournament_date', this.value)">
            </div>
            
            <div class="form-group">
                <label for="match_duration">Match Duration (minutes)</label>
                <input type="number" id="match_duration" name="match_duration" 
                       value="{{ constraints.match_duration_minutes }}" min="15" max="180" required
                       onchange="updateSetting('match_duration', this.value)">
            </div>
            
            <div class="form-group">
                <label for="days_number">Number of Days</label>
                <input type="number" id="days_number" name="days_number" 
                       value="{{ constraints.days_number }}" min="1" max="14" required
                       onchange="updateSetting('days_number', this.value)">
            </div>
            
            <div class="form-group">
                <label for="min_break">Break Between Matches (minutes)</label>
                <input type="number" id="min_break" name="min_break" 
                       value="{{ constraints.min_break_between_matches_minutes }}" min="0" max="120" required
                       onchange="updateSetting('min_break', this.value)">
            </div>
            
            <div class="form-group">
                <label for="day_end_time">Day End Time</label>
                <input type="time" id="day_end_time" name="day_end_time" 
                       value="{{ constraints.day_end_time_limit }}" required
                       onchange="updateSetting('day_end_time', this.value)">
            </div>
            
            <div class="form-group">
                <label for="bracket_type">Elimination Bracket Type</label>
                <select id="bracket_type" name="bracket_type" onchange="updateSetting('bracket_type', this.value)">
                    <option value="single" {% if constraints.bracket_type == 'single' %}selected{% endif %}>Single Elimination</option>
                    <option value="double" {% if constraints.bracket_type == 'double' %}selected{% endif %}>Double Elimination</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="scoring_format">Scoring Format</label>
                <select id="scoring_format" name="scoring_format" onchange="updateSetting('scoring_format', this.value)">
                    <option value="single_set" {% if constraints.scoring_format == 'single_set' %}selected{% endif %}>Single Set</option>
                    <option value="best_of_3" {% if constraints.scoring_format == 'best_of_3' %}selected{% endif %}>Best of 3 Sets</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="pool_to_bracket_delay">Pool to Bracket Delay (minutes)
                    <span class="help-icon" title="Time delay between the end of pool play and the start of bracket play. Use this for lunch breaks, etc.">?</span>
                </label>
                <input type="number" id="pool_to_bracket_delay" name="pool_to_bracket_delay" 
                       value="{{ constraints.pool_to_bracket_delay_minutes | default(0) }}" min="0" max="480"
                       onchange="updateSetting('pool_to_bracket_delay', this.value)">
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="pool_in_same_court" name="pool_in_same_court" 
                           {% if constraints.pool_in_same_court %}checked{% endif %}
                           onchange="updateSetting('pool_in_same_court', this.checked)">
                    Pool in Same Court
                    <span class="help-icon" title="All matches for a pool will be scheduled on the same court.">?</span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="silver_bracket_enabled" name="silver_bracket_enabled" 
                           {% if constraints.silver_bracket_enabled %}checked{% endif %}
                           onchange="updateSetting('silver_bracket_enabled', this.checked)">
                    Silver Bracket
                    <span class="help-icon" title="Teams that don't advance from pool play will compete in a separate Silver Bracket elimination tournament.">?</span>
                </label>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="show_test_buttons" name="show_test_buttons" 
                           {% if constraints.show_test_buttons %}checked{% endif %}
                           onchange="updateSetting('show_test_buttons', this.checked)">
                    Show Test Buttons
                    <span class="help-icon" title="When enabled, shows Test buttons on Teams, Courts, Tracking, and Bracket pages for generating sample data.">?</span>
                </label>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <h2>Team-Specific Constraints</h2>
    <p class="help-text">Set time preferences for specific teams (e.g., "Team A can only play after 10:00 AM").</p>
    
    <form method="POST" class="form-card">
        <input type="hidden" name="action" value="add_team_constraint">
        
        <div class="form-grid">
            <div class="form-group">
                <label for="team_name">Team</label>
                <select id="team_name" name="team_name" required>
                    <option value="">Select a team...</option>
                    {% for team in all_teams %}
                    <option value="{{ team }}">{{ team }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group">
                <label for="play_after">Must Play After (optional)</label>
                <input type="time" id="play_after" name="play_after">
            </div>
            
            <div class="form-group">
                <label for="play_before">Must End Before (optional)</label>
                <input type="time" id="play_before" name="play_before">
            </div>
            
            <div class="form-group">
                <label for="note">Note (optional)</label>
                <input type="text" id="note" name="note" placeholder="Reason for constraint">
            </div>
        </div>
        
        <button type="submit" class="btn btn-success">Add Constraint</button>
    </form>
    
    {% if constraints.team_specific_constraints %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Team</th>
                <th>Play After</th>
                <th>End Before</th>
                <th>Note</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for tc in constraints.team_specific_constraints %}
            <tr>
                <td>{{ tc.team_name }}</td>
                <td>{{ tc.play_after if tc.play_after else '-' }}</td>
                <td>{{ tc.play_before if tc.play_before else '-' }}</td>
                <td>{{ tc.note if tc.note else '-' }}</td>
                <td>
                    <form method="POST" class="inline">
                        <input type="hidden" name="action" value="delete_team_constraint">
                        <input type="hidden" name="team_name" value="{{ tc.team_name }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-message">No team-specific constraints defined.</p>
    {% endif %}
</section>

<section class="section">
    <h2>Actions</h2>
    <p class="help-text">Delete all teams, courts, schedules, results, and settings.</p>
    <button type="button" class="btn btn-danger" style="width: auto;" onclick="resetAll()">Reset All Data</button>
</section>

<script>
function updateSetting(field, value) {
    const data = {};
    data[field] = value;
    
    fetch('/api/settings/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
}

function uploadLogo(input) {
    if (!input.files || !input.files[0]) return;
    const formData = new FormData();
    formData.append('logo', input.files[0]);
    
    fetch('/api/upload-logo', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('logo-preview').src = '/api/logo?' + Date.now();
        } else {
            alert(data.error || 'Upload failed');
        }
    });
}

function resetAll() {
    if (!confirm('Are you sure you want to reset all data? This will delete all teams, courts, schedules, results, and settings.')) {
        return;
    }
    fetch('/api/reset', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function confirmDeleteAccount() {
    const typed = prompt('This will permanently delete your account and all tournament data.\n\nType "DELETE" to confirm:');
    if (typed === 'DELETE') {
        fetch('{{ url_for("api_delete_account") }}', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json().then(data => ({ok: response.ok, data})))
        .then(({ok, data}) => {
            if (ok) {
                window.location.href = data.redirect;
            } else {
                alert(data.error || 'Failed to delete account.');
            }
        })
        .catch(() => alert('Network error ‚Äî please try again.'));
    } else if (typed !== null) {
        alert('Deletion cancelled ‚Äî you must type exactly "DELETE" to proceed.');
    }
}
</script>

<section class="section section-danger-zone">
    <h2>‚ö†Ô∏è Delete Account</h2>
    <p>Permanently delete your account and all tournament data. This action cannot be undone.</p>
    <button onclick="confirmDeleteAccount()" class="btn btn-danger btn-sm">üóëÔ∏è Delete My Account</button>
</section>

{% endblock %}
