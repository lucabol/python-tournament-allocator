<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#ffffff">
    <title>Live Tournament</title>
    <link rel="icon" href="/api/logo">
    <link rel="stylesheet" href="{{ url_for('static', filename='live.css') }}">
</head>
<body>
    <header class="live-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            {% include '_tournament_header.html' %}
        </div>
        <div>
            <span class="sse-status">
                <span id="sse-dot" class="sse-dot disconnected"></span>
                <span id="sse-label">Connectingâ€¦</span>
            </span>
        </div>
    </header>

    <div class="team-filter-bar">
        <input type="search" id="team-filter" class="team-filter-input"
               placeholder="ðŸ” Find my teamâ€¦" autocomplete="off" spellcheck="false">
    </div>

    <main class="live-container" id="live-content">
{% include 'live_content.html' %}
    </main>

    <div style="display:flex;justify-content:center;padding:1.5rem 0;">
        <div id="qr-share" style="display:inline-flex;flex-direction:column;align-items:center;gap:0.4rem;background:rgba(255,255,255,0.1);padding:0.75rem 1rem;border-radius:10px;cursor:pointer;" onclick="copyShareLink()" title="Click to copy link">
            <div id="qr-share-container" style="background:#fff;padding:4px;border-radius:6px;line-height:0;"></div>
            <span id="qr-share-label" style="font-size:0.8rem;color:var(--text-muted,#888);">Share this page</span>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
    (function() {
        var qr = qrcode(0, 'M');
        qr.addData(window.location.href);
        qr.make();
        var container = document.getElementById('qr-share-container');
        if (container) {
            container.innerHTML = qr.createSvgTag(2, 0);
            var svg = container.querySelector('svg');
            if (svg) { svg.style.width = '80px'; svg.style.height = '80px'; }
        }
    })();
    function copyShareLink() {
        var label = document.getElementById('qr-share-label');
        navigator.clipboard.writeText(window.location.href).then(function() {
            if (label) { var orig = label.textContent; label.textContent = 'âœ… Link copied!'; setTimeout(function() { label.textContent = orig; }, 2000); }
        });
    }
    </script>

    <footer class="live-footer">
        <p>Tournament Allocator &copy; 2026</p>
    </footer>

<script>
{% if public_mode %}
var liveHtmlUrl = '/api/live-html/{{ public_username }}/{{ public_slug }}';
var liveStreamUrl = '/api/live-stream/{{ public_username }}/{{ public_slug }}';
{% else %}
var liveHtmlUrl = '/api/live-html';
var liveStreamUrl = '/api/live-stream';
{% endif %}

document.addEventListener('DOMContentLoaded', function() {
    var contentEl = document.getElementById('live-content');
    var dotEl = document.getElementById('sse-dot');
    var labelEl = document.getElementById('sse-label');
    var filterInput = document.getElementById('team-filter');

    function setStatus(state) {
        dotEl.className = 'sse-dot ' + state;
        labelEl.textContent = state === 'connected' ? 'Live' :
                              state === 'reconnecting' ? 'Reconnectingâ€¦' : 'Disconnected';
    }

    function applyFilter() {
        var query = filterInput.value.trim().toLowerCase();
        var items = contentEl.querySelectorAll('[data-teams]');
        items.forEach(function(el) {
            if (!query) {
                el.classList.remove('filter-hidden', 'filter-highlight');
                return;
            }
            var teams = el.getAttribute('data-teams').toLowerCase();
            if (teams.indexOf(query) !== -1) {
                el.classList.remove('filter-hidden');
                el.classList.add('filter-highlight');
            } else {
                el.classList.add('filter-hidden');
                el.classList.remove('filter-highlight');
            }
        });
    }

    filterInput.addEventListener('input', applyFilter);

    function fetchContent() {
        fetch(liveHtmlUrl)
            .then(function(r) { return r.text(); })
            .then(function(html) { contentEl.innerHTML = html; applyFilter(); })
            .catch(function(err) { console.error('Failed to fetch live content:', err); });
    }

    if (typeof EventSource === 'undefined') {
        setStatus('connected');
        labelEl.textContent = 'Polling (30s)';
        setInterval(fetchContent, 30000);
        return;
    }

    var source = new EventSource(liveStreamUrl);
    source.addEventListener('open', function() { setStatus('connected'); });
    source.addEventListener('connected', function() { setStatus('connected'); });
    source.addEventListener('update', function() { fetchContent(); });
    source.addEventListener('error', function() {
        setStatus(source.readyState === EventSource.CONNECTING ? 'reconnecting' : 'disconnected');
    });
});
</script>
</body>
</html>
