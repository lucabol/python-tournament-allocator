{% extends "base.html" %}

{% block title %}Courts - Tournament Allocator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Court Management</h1>
    <div class="page-header-actions">
        {% if show_test_buttons %}<button type="button" class="btn btn-sm btn-secondary" onclick="loadTestCourts()">Test</button>{% endif %}
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<section class="section">
    <h2>Add New Court</h2>
    <form method="POST" class="form-grid">
        <input type="hidden" name="action" value="add_court">
        <div class="form-group">
            <label for="court_name">Court Name</label>
            <input type="text" id="court_name" name="court_name" placeholder="e.g., Court 1" required>
        </div>
        <div class="form-group">
            <label for="start_time">Opens At</label>
            <input type="time" id="start_time" name="start_time" value="08:00" required>
        </div>
        <div class="form-group">
            <label for="end_time">Closes At</label>
            <input type="time" id="end_time" name="end_time" value="22:00" required>
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Add Court</button>
        </div>
    </form>
</section>

<section class="section">
    <h2>Load from YAML 
        <span class="help-icon" onclick="document.getElementById('courts-yaml-help').style.display='flex'">?</span>
    </h2>
    <form method="POST" enctype="multipart/form-data" class="inline-form" id="courts-yaml-form">
        <input type="hidden" name="action" value="load_yaml">
        <input type="file" name="yaml_file" accept=".yaml,.yml" required style="display:none" id="courts-yaml-input" onchange="document.getElementById('courts-yaml-form').submit()">
        <button type="button" class="btn btn-primary" onclick="document.getElementById('courts-yaml-input').click()">Load</button>
    </form>
    <p class="help-text">Loading will replace all existing courts and clear the schedule.</p>
</section>

<div id="courts-yaml-help" class="modal-overlay" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Courts YAML Format</h3>
            <button class="modal-close" onclick="document.getElementById('courts-yaml-help').style.display='none'">&times;</button>
        </div>
        <pre id="courts-yaml-example">- name: Court 1
  start_time: '08:00'
  end_time: '22:00'

- name: Court 2
  start_time: '09:00'
  end_time: '21:00'</pre>
        <button class="btn btn-primary" onclick="navigator.clipboard.writeText(document.getElementById('courts-yaml-example').textContent);this.textContent='Copied!';setTimeout(()=>this.textContent='Copy to Clipboard',2000)">Copy to Clipboard</button>
    </div>
</div>

{% if courts %}
<section class="section">
    <h2>Available Courts</h2>
    <table class="data-table">
        <thead>
            <tr>
                <th>Court Name</th>
                <th>Opens</th>
                <th>Closes</th>
                <th>Hours Available</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for court in courts %}
            <tr>
                <td>
                    <input type="text" value="{{ court.name }}" class="court-name-input"
                           onchange="saveCourtName(this, '{{ court.name }}')">
                </td>
                <td>{{ court.start_time }}</td>
                <td>{{ court.end_time }}</td>
                <td>
                    {% set start_parts = court.start_time.split(':') %}
                    {% set end_parts = court.end_time.split(':') %}
                    {% set start_mins = start_parts[0]|int * 60 + start_parts[1]|int %}
                    {% set end_mins = end_parts[0]|int * 60 + end_parts[1]|int %}
                    {% if end_mins <= start_mins %}
                        {% set hours = (24 * 60 - start_mins + end_mins) // 60 %}
                    {% else %}
                        {% set hours = (end_mins - start_mins) // 60 %}
                    {% endif %}
                    {{ hours }} hours
                </td>
                <td>
                    <form method="POST" class="inline" onsubmit="return confirm('Delete this court?');">
                        <input type="hidden" name="action" value="delete_court">
                        <input type="hidden" name="court_name" value="{{ court.name }}">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
{% else %}
<div class="empty-state">
    <h2>No courts yet</h2>
    <p>Add a court above to get started.</p>
</div>
{% endif %}

<script>
async function saveCourtName(input, oldName) {
    const newName = input.value.trim();
    if (newName === oldName) return;
    
    const response = await fetch('/api/courts/edit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({old_name: oldName, new_name: newName})
    });
    const result = await response.json();
    if (!result.success) {
        alert(result.error);
        input.value = oldName;
    } else {
        input.setAttribute('onchange', `saveCourtName(this, '${newName}')`);
    }
}

function loadTestCourts() {
    fetch('/api/test-courts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %}
