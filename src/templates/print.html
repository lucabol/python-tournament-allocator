{% extends "base.html" %}

{% block title %}Official Tournament Documentation{% endblock %}

{% block content %}
<div class="print-view formal-document">
    <div class="page-header formal-header">
        <div class="print-header-logo">
            <img src="https://montgobvc.com/wp-content/uploads/2024/02/LOGO-MBVC-001.png" alt="Montg√≥ Beach Volley Club" class="print-logo">
            <div class="print-titles">
                <div class="organization-name">Montg√≥ Beach Volley Club</div>
                <h1 contenteditable="true" class="editable-title" id="print-title" onblur="savePrintSettings()">{{ print_settings.title }}</h1>
                <h2 contenteditable="true" class="editable-subtitle" id="print-subtitle" onblur="savePrintSettings()">{{ print_settings.subtitle }}</h2>
            </div>
        </div>
        <button type="button" class="btn btn-primary btn-sm no-print" onclick="window.print()">Print</button>
    </div>

    <hr class="formal-divider">

    <!-- Section 1: Participating Teams -->
    <section class="print-section">
        <h2>Section 1: Participating Teams and Pool Assignments</h2>
        {% if pools %}
        <p class="section-intro">The following teams have registered for participation in this tournament and have been assigned to competition pools as indicated below.</p>
        {% for pool_name, pool_data in pools.items() %}
        <h3>{{ pool_name }}</h3>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Team Name</th>
                </tr>
            </thead>
            <tbody>
                {% for team in pool_data.teams %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ team }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="print-note">Number of teams advancing to elimination round: {{ pool_data.advance }}</p>
        {% endfor %}
        <p class="total-teams"><strong>Total Registered Teams:</strong> {{ pools.values()|map(attribute='teams')|map('length')|sum }}</p>
        {% else %}
        <p>No teams have been registered.</p>
        {% endif %}
    </section>

    <!-- Section 2: Venue and Facilities -->
    <section class="print-section">
        <h2>Section 2: Venue and Court Allocation</h2>
        <p class="section-intro">The following courts have been designated for tournament use with the specified operational hours.</p>
        {% if courts %}
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Court Designation</th>
                    <th>Opening Time</th>
                    <th>Closing Time</th>
                </tr>
            </thead>
            <tbody>
                {% for court in courts %}
                <tr>
                    <td>{{ court.name }}</td>
                    <td>{{ court.start_time }}</td>
                    <td>{{ court.end_time }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="print-note"><strong>Location:</strong> Playa del Arenal, X√†bia/J√°vea</p>
        {% else %}
        <p>Court allocation pending.</p>
        {% endif %}
    </section>

    <!-- Section 3: Tournament Regulations -->
    <section class="print-section">
        <h2>Section 3: Tournament Regulations and Format</h2>
        <p class="section-intro">The tournament shall be conducted in accordance with the following parameters:</p>
        <table class="print-table formal-table regulations-table">
            <tbody>
                <tr><td><strong>Match Duration</strong></td><td>{{ constraints.match_duration_minutes }} minutes (maximum)</td></tr>
                <tr><td><strong>Minimum Rest Period</strong></td><td>{{ constraints.min_break_between_matches_minutes }} minutes between matches</td></tr>
                <tr><td><strong>Scoring Format</strong></td><td>{{ constraints.scoring_format|default('best_of_3')|replace('_', ' ')|title }}</td></tr>
                <tr><td><strong>Elimination Format</strong></td><td>{{ constraints.bracket_type|default('single')|replace('_', ' ')|title }} Elimination</td></tr>
                <tr><td><strong>Secondary Bracket</strong></td><td>{% if constraints.silver_bracket_enabled %}Enabled (Silver Bracket){% else %}Not Applicable{% endif %}</td></tr>
                <tr><td><strong>Court Assignment Policy</strong></td><td>{% if constraints.pool_same_court %}Teams remain on assigned court{% else %}Variable court assignment{% endif %}</td></tr>
            </tbody>
        </table>
    </section>

    <!-- Section 4: Competition Schedule -->
    <section class="print-section">
        <h2>Section 4: Official Match Schedule</h2>
        {% if schedule %}
        <p class="section-intro">All matches shall be conducted according to the following schedule. Times are approximate and subject to match duration.</p>
        {% for day, day_data in schedule.items() %}
        <h3>{{ day }}</h3>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Scheduled Time</th>
                    <th>Court</th>
                    <th>Pool</th>
                    <th>Match</th>
                </tr>
            </thead>
            <tbody>
                {% for item in day_data.get('_sorted_matches', []) %}
                <tr>
                    <td>{{ item.match.start_time }} - {{ item.match.end_time }}</td>
                    <td>{{ item.court }}</td>
                    <td>{{ item.match.pool }}</td>
                    <td>{{ item.match.teams[0] }} vs {{ item.match.teams[1] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
        {% else %}
        <p>Schedule pending generation.</p>
        {% endif %}
    </section>

    <!-- Section 5: Pool Phase Results -->
    <section class="print-section">
        <h2>Section 5: Pool Phase Standings</h2>
        {% if standings %}
        <p class="section-intro">Final standings for each pool following round-robin competition. Teams highlighted in green have qualified for the elimination phase.</p>
        {% for pool_name, pool_standings in standings.items() %}
        <h3>{{ pool_name }}</h3>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Position</th>
                    <th>Team</th>
                    <th>Wins</th>
                    <th>Losses</th>
                    <th>Set Diff.</th>
                    <th>Point Diff.</th>
                </tr>
            </thead>
            <tbody>
                {% for team in pool_standings %}
                {% set advance_count = pools[pool_name].advance if pools and pool_name in pools else 2 %}
                <tr {% if loop.index <= advance_count and team.matches_played > 0 %}class="advancing"{% endif %}>
                    <td>{{ loop.index }}</td>
                    <td>{{ team.team }}</td>
                    <td>{{ team.wins }}</td>
                    <td>{{ team.losses }}</td>
                    <td>{{ team.sets_won - team.sets_lost }}</td>
                    <td>{{ team.points_for - team.points_against }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
        {% else %}
        <p>Pool phase results pending.</p>
        {% endif %}
    </section>

    <!-- Section 6: Elimination Bracket -->
    <section class="print-section">
        <h2>Section 6: Elimination Phase</h2>
        {% if bracket_data %}
        <p class="section-intro">Teams advancing from pool play compete in the elimination bracket as detailed below.</p>
        
        <h3>6.1 Seeding</h3>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Seed</th>
                    <th>Team</th>
                    <th>Pool Origin</th>
                </tr>
            </thead>
            <tbody>
                {% for team_name, seed, pool_name in bracket_data.seeded_teams %}
                <tr>
                    <td>#{{ seed }}</td>
                    <td>{{ team_name }}</td>
                    <td>{{ pool_name }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3>6.2 Winners Bracket</h3>
        {% for round_name, matches in bracket_data.winners_bracket.items() %}
        <h4>{{ round_name }}</h4>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Match No.</th>
                    <th>Team 1</th>
                    <th>Team 2</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.match_number }}</td>
                    <td>{{ match.teams[0] }}</td>
                    <td>{{ match.teams[1] }}</td>
                    <td>{{ match.winner if match.winner else 'Pending' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}

        {% if bracket_data.losers_bracket %}
        <h3>6.3 Losers Bracket (Consolation)</h3>
        {% for round_name, matches in bracket_data.losers_bracket.items() %}
        <h4>{{ round_name }}</h4>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Match No.</th>
                    <th>Team 1</th>
                    <th>Team 2</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.match_number }}</td>
                    <td>{{ match.teams[0] }}</td>
                    <td>{{ match.teams[1] }}</td>
                    <td>{{ match.winner if match.winner else 'Pending' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}
        {% endif %}

        {% if bracket_data.grand_final %}
        <h3>6.4 Championship Final</h3>
        <table class="print-table formal-table">
            <tbody>
                <tr>
                    <td><strong>Finalists:</strong> {{ bracket_data.grand_final.teams[0] }} vs {{ bracket_data.grand_final.teams[1] }}</td>
                    <td><strong>Champion:</strong> {{ bracket_data.grand_final.winner if bracket_data.grand_final.winner else 'To Be Determined' }}</td>
                </tr>
            </tbody>
        </table>
        {% endif %}

        {% if bracket_data.champion %}
        <div class="champion-box">
            <p class="champion-note"><strong>üèÜ TOURNAMENT CHAMPION: {{ bracket_data.champion }}</strong></p>
        </div>
        {% endif %}

        {% else %}
        <p>Elimination bracket pending pool phase completion.</p>
        {% endif %}

        {% if silver_bracket_data %}
        <h3>6.5 Secondary Competition (Silver Bracket)</h3>
        <p class="section-intro">Teams eliminated in the first round of the main bracket compete for secondary honors.</p>
        
        <h4>Silver Winners Bracket</h4>
        {% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
        <h5>{{ round_name }}</h5>
        <table class="print-table formal-table">
            <thead>
                <tr>
                    <th>Match No.</th>
                    <th>Team 1</th>
                    <th>Team 2</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.match_number }}</td>
                    <td>{{ match.teams[0] }}</td>
                    <td>{{ match.teams[1] }}</td>
                    <td>{{ match.winner if match.winner else 'Pending' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endfor %}

        {% if silver_bracket_data.champion %}
        <div class="champion-box silver">
            <p class="champion-note"><strong>ü•à SILVER BRACKET CHAMPION: {{ silver_bracket_data.champion }}</strong></p>
        </div>
        {% endif %}
        {% endif %}
    </section>

</div>

<style>
@media print {
    nav, footer, .btn, .page-header button, .no-print {
        display: none !important;
    }
    .print-view {
        padding: 0;
        margin: 0;
    }
    .page-header {
        margin-bottom: 0.5rem !important;
    }
    .print-section {
        page-break-inside: auto;
    }
    .print-section h2 {
        page-break-after: avoid;
    }
    .print-table {
        page-break-inside: auto;
    }
    .print-table tr {
        page-break-inside: avoid;
    }
    .editable-title, .editable-subtitle {
        border: none !important;
        padding: 0 !important;
    }
    .document-meta {
        border: none !important;
        background: none !important;
    }
    .formal-divider {
        margin: 0.5rem 0 !important;
    }
}

.formal-document {
    font-family: 'Times New Roman', Times, serif;
    line-height: 1.6;
}

.formal-header {
    border-bottom: 3px double #1f2937;
    padding-bottom: 1rem;
    margin-bottom: 1rem;
}

.organization-name {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #374151;
}

.document-meta {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    padding: 1rem;
    margin: 1rem 0;
    font-size: 0.9rem;
}

.document-meta p {
    margin: 0.25rem 0;
}

.formal-divider {
    border: none;
    border-top: 1px solid #d1d5db;
    margin: 1.5rem 0;
}

.section-intro {
    font-style: italic;
    color: #4b5563;
    margin-bottom: 1rem;
    font-size: 0.95rem;
}

.total-teams {
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
}

.print-view {
    max-width: 900px;
    margin: 0 auto;
}

.print-header-logo {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.print-titles {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.print-logo {
    height: 70px;
    width: auto;
}

.editable-title, .editable-subtitle {
    border: 1px dashed transparent;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: text;
    margin: 0;
    font-family: 'Times New Roman', Times, serif;
}

.editable-title {
    font-size: 1.75rem;
}

.editable-subtitle {
    font-size: 1.1rem;
    font-weight: normal;
    color: #4b5563;
}

.editable-title:hover, .editable-subtitle:hover {
    border-color: #9ca3af;
}

.editable-title:focus, .editable-subtitle:focus {
    outline: none;
    border-color: #3b82f6;
    background: #f0f9ff;
}

.print-section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
}

.print-section h2 {
    color: #1f2937;
    border-bottom: 2px solid #1f2937;
    padding-bottom: 0.5rem;
    margin-bottom: 1rem;
    font-size: 1.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.print-section h3 {
    color: #374151;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}

.print-section h4 {
    color: #4b5563;
    margin-top: 0.75rem;
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}

.print-section h5 {
    color: #6b7280;
    margin-top: 0.5rem;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.print-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.print-table th,
.print-table td {
    border: 1px solid #d1d5db;
    padding: 0.5rem;
    text-align: left;
}

.print-table th {
    background: #f3f4f6;
    font-weight: 600;
}

.print-table tr.advancing {
    background: #dcfce7;
}

.print-note {
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.5rem;
}

.champion-box {
    background: #fef3c7;
    border: 2px solid #f59e0b;
    padding: 1rem;
    margin-top: 1rem;
    text-align: center;
}

.champion-box.silver {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.champion-note {
    font-size: 1.1rem;
    margin: 0;
}

.signature-section {
    margin-top: 3rem;
}

.signature-block {
    display: flex;
    justify-content: space-between;
    margin: 2rem 0;
    gap: 2rem;
}

.signature-line {
    flex: 1;
    text-align: center;
}

.signature-line p {
    margin: 0.25rem 0;
}

.signature-label {
    font-size: 0.85rem;
    color: #6b7280;
}

.formal-table {
    border: 2px solid #374151;
}

.formal-table th {
    background: #374151;
    color: white;
}

.regulations-table td:first-child {
    width: 40%;
    font-weight: 500;
}
</style>

<script>
function savePrintSettings() {
    const title = document.getElementById('print-title').innerText.trim();
    const subtitle = document.getElementById('print-subtitle').innerText.trim();
    
    fetch('/api/print-settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: title, subtitle: subtitle})
    });
}
</script>
{% endblock %}
