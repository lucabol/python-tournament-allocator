{% extends "base.html" %}

{% block title %}{{ constraints.tournament_name | default('Tournament') }} ‚Äî Insta{% endblock %}

{% block content %}
<div class="insta-wrapper">
    <div class="insta-card" id="insta-card">

        {# ---- HEADER ---- #}
        <div class="insta-header">
            <img src="/api/logo" alt="" class="insta-logo">
            <div class="insta-header-text">
                {% if constraints.club_name %}<div class="insta-club">{{ constraints.club_name }}</div>{% endif %}
                <h1 class="insta-title">{{ constraints.tournament_name | default('Tournament') }}</h1>
                {% if constraints.tournament_date %}<div class="insta-date">{{ constraints.tournament_date }}</div>{% endif %}
            </div>
        </div>

        {# ---- CHAMPIONS ---- #}
        {% if bracket_data and bracket_data.champion %}
        <div class="insta-champion gold">
            <span class="insta-champion-emoji">üèÜ</span>
            <div class="insta-champion-label">Gold Champion</div>
            <div class="insta-champion-name">{{ bracket_data.champion }}</div>
        </div>
        {% endif %}

        {% if silver_bracket_data and silver_bracket_data.champion %}
        <div class="insta-champion silver">
            <span class="insta-champion-emoji">ü•à</span>
            <div class="insta-champion-label">Silver Champion</div>
            <div class="insta-champion-name">{{ silver_bracket_data.champion }}</div>
        </div>
        {% endif %}

        {# ---- POOL STANDINGS ---- #}
        {% if standings %}
        <div class="insta-section">
            <div class="insta-section-title">Pool Standings</div>
            {% for pool_name, team_list in standings.items() %}
            <div class="insta-pool">
                <div class="insta-pool-name">{{ pool_name }}</div>
                <table class="insta-table">
                    <thead>
                        <tr><th>#</th><th>Team</th><th>W</th><th>L</th></tr>
                    </thead>
                    <tbody>
                        {% for team in team_list %}
                        {% set advance_count = pools[pool_name].advance if pools and pool_name in pools else 2 %}
                        <tr class="{% if loop.index <= advance_count and team.matches_played > 0 %}insta-advancing{% endif %}">
                            <td>{{ loop.index }}</td>
                            <td>{{ team.team }}</td>
                            <td>{{ team.wins }}</td>
                            <td>{{ team.losses }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {# ---- BRACKET RESULTS ---- #}
        {% if bracket_data %}
        <div class="insta-section">
            <div class="insta-section-title">ü•á Gold Bracket</div>

            {# Winners Bracket #}
            {% for round_name, matches in bracket_data.winners_bracket.items() %}
            <div class="insta-bracket-round">{{ round_name }}</div>
            {% for match in matches %}
            {% if not match.is_bye %}
            <div class="insta-bracket-match {% if match.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if match.winner == match.teams[0] %}insta-winner{% endif %}">{{ match.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if match.winner == match.teams[1] %}insta-winner{% endif %}">{{ match.teams[1] }}</span>
                {% if match.result and match.result.sets %}
                <span class="insta-score">{{ match.result.sets | map('first') | join('-') }} / {{ match.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}

            {# Losers Bracket #}
            {% if bracket_data.losers_bracket %}
            <div class="insta-bracket-sub">Losers Bracket</div>
            {% for round_name, matches in bracket_data.losers_bracket.items() %}
            <div class="insta-bracket-round">{{ round_name }}</div>
            {% for match in matches %}
            <div class="insta-bracket-match {% if match.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if match.winner == match.teams[0] %}insta-winner{% endif %}">{{ match.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if match.winner == match.teams[1] %}insta-winner{% endif %}">{{ match.teams[1] }}</span>
                {% if match.result and match.result.sets %}
                <span class="insta-score">{{ match.result.sets | map('first') | join('-') }} / {{ match.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endfor %}
            {% endfor %}
            {% endif %}

            {# Grand Final #}
            {% if bracket_data.grand_final %}
            <div class="insta-bracket-sub">Grand Final</div>
            <div class="insta-bracket-match insta-grand-final {% if bracket_data.grand_final.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[0] %}insta-winner{% endif %}">{{ bracket_data.grand_final.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[1] %}insta-winner{% endif %}">{{ bracket_data.grand_final.teams[1] }}</span>
                {% if bracket_data.grand_final.result and bracket_data.grand_final.result.sets %}
                <span class="insta-score">{{ bracket_data.grand_final.result.sets | map('first') | join('-') }} / {{ bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% if bracket_data.bracket_reset and bracket_data.bracket_reset.get('needs_reset') %}
            <div class="insta-bracket-round">Bracket Reset</div>
            <div class="insta-bracket-match insta-grand-final {% if bracket_data.bracket_reset.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[0] %}insta-winner{% endif %}">{{ bracket_data.bracket_reset.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[1] %}insta-winner{% endif %}">{{ bracket_data.bracket_reset.teams[1] }}</span>
                {% if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets %}
                <span class="insta-score">{{ bracket_data.bracket_reset.result.sets | map('first') | join('-') }} / {{ bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}

        {# ---- SILVER BRACKET ---- #}
        {% if silver_bracket_data %}
        <div class="insta-section">
            <div class="insta-section-title">ü•à Silver Bracket</div>

            {% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
            <div class="insta-bracket-round">{{ round_name }}</div>
            {% for match in matches %}
            {% if not match.is_bye %}
            <div class="insta-bracket-match {% if match.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if match.winner == match.teams[0] %}insta-winner{% endif %}">{{ match.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if match.winner == match.teams[1] %}insta-winner{% endif %}">{{ match.teams[1] }}</span>
                {% if match.result and match.result.sets %}
                <span class="insta-score">{{ match.result.sets | map('first') | join('-') }} / {{ match.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}

            {% if silver_bracket_data.losers_bracket %}
            <div class="insta-bracket-sub">Losers Bracket</div>
            {% for round_name, matches in silver_bracket_data.losers_bracket.items() %}
            <div class="insta-bracket-round">{{ round_name }}</div>
            {% for match in matches %}
            <div class="insta-bracket-match {% if match.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if match.winner == match.teams[0] %}insta-winner{% endif %}">{{ match.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if match.winner == match.teams[1] %}insta-winner{% endif %}">{{ match.teams[1] }}</span>
                {% if match.result and match.result.sets %}
                <span class="insta-score">{{ match.result.sets | map('first') | join('-') }} / {{ match.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endfor %}
            {% endfor %}
            {% endif %}

            {% if silver_bracket_data.grand_final %}
            <div class="insta-bracket-sub">Silver Grand Final</div>
            <div class="insta-bracket-match insta-grand-final {% if silver_bracket_data.grand_final.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[0] %}insta-winner{% endif %}">{{ silver_bracket_data.grand_final.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[1] %}insta-winner{% endif %}">{{ silver_bracket_data.grand_final.teams[1] }}</span>
                {% if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets %}
                <span class="insta-score">{{ silver_bracket_data.grand_final.result.sets | map('first') | join('-') }} / {{ silver_bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% if silver_bracket_data.bracket_reset and silver_bracket_data.bracket_reset.get('needs_reset') %}
            <div class="insta-bracket-round">Silver Bracket Reset</div>
            <div class="insta-bracket-match insta-grand-final {% if silver_bracket_data.bracket_reset.get('winner') %}insta-match-done{% endif %}">
                <span class="{% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[0] %}insta-winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[0] }}</span>
                <span class="insta-vs">v</span>
                <span class="{% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[1] %}insta-winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[1] }}</span>
                {% if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets %}
                <span class="insta-score">{{ silver_bracket_data.bracket_reset.result.sets | map('first') | join('-') }} / {{ silver_bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}

        {# ---- AWARDS ---- #}
        {% if awards %}
        <div class="insta-section">
            <div class="insta-section-title">Awards</div>
            <div class="insta-awards">
                {% for award in awards %}
                <div class="insta-award">
                    {% if award.image %}
                        {% if award.image.startswith('custom-') %}
                        <img src="{{ url_for('api_awards_image', filename=award.image) }}" alt="" class="insta-award-img">
                        {% else %}
                        <img src="{{ url_for('static', filename='awards/' ~ award.image) }}" alt="" class="insta-award-img">
                        {% endif %}
                    {% endif %}
                    <div class="insta-award-name">{{ award.name }}</div>
                    <div class="insta-award-player">{{ award.player }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# ---- FOOTER WATERMARK ---- #}
        <div class="insta-footer">üèê Tournament Allocator</div>

    </div>{# /insta-card #}
</div>{# /insta-wrapper #}

<style>
/* ===== Insta Story Card ===== */
.insta-wrapper {
    display: flex;
    justify-content: center;
    padding: 1.5rem 0.5rem;
}

.insta-card {
    width: 100%;
    max-width: 480px;
    background: linear-gradient(135deg, #1e1040 0%, #0f2557 50%, #0a1628 100%);
    border-radius: 1.25rem;
    padding: 2rem 1.5rem;
    color: #f0f0f5;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.45);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    position: relative;
    overflow: hidden;
}

/* Subtle sparkle overlay */
.insta-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 20% 10%, rgba(255,255,255,0.06) 0%, transparent 50%),
                radial-gradient(circle at 80% 90%, rgba(120,100,255,0.08) 0%, transparent 40%);
    pointer-events: none;
}

/* ---- Header ---- */
.insta-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    position: relative;
}

.insta-logo {
    width: 56px;
    height: 56px;
    border-radius: 0.75rem;
    object-fit: cover;
    border: 2px solid rgba(255,255,255,0.2);
}

.insta-club {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: rgba(255,255,255,0.55);
    font-weight: 600;
}

.insta-title {
    font-size: 1.55rem;
    font-weight: 800;
    margin: 0;
    line-height: 1.15;
    background: linear-gradient(90deg, #ffffff 0%, #c8bfff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.insta-date {
    font-size: 0.8rem;
    color: rgba(255,255,255,0.5);
    margin-top: 0.15rem;
}

/* ---- Champions ---- */
.insta-champion {
    text-align: center;
    padding: 1.25rem 1rem;
    border-radius: 1rem;
    margin-bottom: 1rem;
    position: relative;
}

.insta-champion.gold {
    background: linear-gradient(135deg, rgba(255,193,7,0.2) 0%, rgba(255,152,0,0.15) 100%);
    border: 1px solid rgba(255,193,7,0.35);
}

.insta-champion.silver {
    background: linear-gradient(135deg, rgba(189,189,189,0.15) 0%, rgba(158,158,158,0.1) 100%);
    border: 1px solid rgba(189,189,189,0.3);
}

.insta-champion-emoji {
    font-size: 2.5rem;
    display: block;
    margin-bottom: 0.25rem;
}

.insta-champion-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: rgba(255,255,255,0.6);
    font-weight: 600;
}

.insta-champion.gold .insta-champion-name {
    font-size: 1.6rem;
    font-weight: 800;
    background: linear-gradient(90deg, #ffd54f, #ffab00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-top: 0.25rem;
}

.insta-champion.silver .insta-champion-name {
    font-size: 1.35rem;
    font-weight: 700;
    color: #cfd8dc;
    margin-top: 0.25rem;
}

/* ---- Sections ---- */
.insta-section {
    margin-bottom: 1.25rem;
}

.insta-section-title {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: rgba(255,255,255,0.45);
    font-weight: 700;
    margin-bottom: 0.75rem;
    padding-left: 0.25rem;
}

/* ---- Pool tables ---- */
.insta-pool {
    margin-bottom: 0.75rem;
}

.insta-pool-name {
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(255,255,255,0.65);
    margin-bottom: 0.35rem;
    padding-left: 0.25rem;
}

.insta-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8rem;
}

.insta-table th {
    text-align: left;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: rgba(255,255,255,0.35);
    padding: 0.3rem 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    font-weight: 600;
}

.insta-table td {
    padding: 0.35rem 0.5rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.8);
}

.insta-table tr.insta-advancing td {
    color: #a5d6a7;
    font-weight: 600;
}

.insta-table tr.insta-advancing td:first-child::before {
    content: '‚ñ∏ ';
    color: #66bb6a;
}

/* ---- Awards ---- */
.insta-awards {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 0.75rem;
}

.insta-award {
    background: rgba(255,255,255,0.06);
    border-radius: 0.75rem;
    padding: 0.75rem 0.5rem;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.08);
}

.insta-award-img {
    width: 36px;
    height: 36px;
    margin-bottom: 0.4rem;
    opacity: 0.85;
}

.insta-award-name {
    font-size: 0.7rem;
    font-weight: 700;
    color: rgba(255,255,255,0.75);
    margin-bottom: 0.15rem;
}

.insta-award-player {
    font-size: 0.75rem;
    font-weight: 600;
    color: #e0d6ff;
}

/* ---- Bracket results ---- */
.insta-bracket-round {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgba(255,255,255,0.4);
    font-weight: 600;
    margin: 0.5rem 0 0.25rem 0.25rem;
}

.insta-bracket-sub {
    font-size: 0.7rem;
    font-weight: 700;
    color: rgba(255,255,255,0.55);
    margin: 0.75rem 0 0.25rem 0.25rem;
}

.insta-bracket-match {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.5rem;
    font-size: 0.78rem;
    color: rgba(255,255,255,0.55);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
}

.insta-bracket-match.insta-match-done {
    color: rgba(255,255,255,0.75);
}

.insta-bracket-match.insta-grand-final {
    background: rgba(255,255,255,0.04);
    border-radius: 0.5rem;
    margin-top: 0.25rem;
    border-bottom: none;
}

.insta-vs {
    font-size: 0.6rem;
    color: rgba(255,255,255,0.3);
    font-style: italic;
}

.insta-winner {
    color: #a5d6a7;
    font-weight: 700;
}

.insta-score {
    margin-left: auto;
    font-size: 0.65rem;
    color: rgba(255,255,255,0.4);
    font-variant-numeric: tabular-nums;
}

/* ---- Footer watermark ---- */
.insta-footer {
    text-align: center;
    font-size: 0.6rem;
    color: rgba(255,255,255,0.2);
    margin-top: 1.5rem;
    letter-spacing: 0.1em;
}
</style>
{% endblock %}
