{% extends "base.html" %}

{% block title %}Double Elimination Bracket - Tournament Allocator{% endblock %}

{# --- Macro: mobile bracket match item with score inputs --- #}
{% macro mobile_bracket_match(match, scoring_format, bracket_type='winners', extra_class='') %}
{% set is_bye = match.is_bye if match.is_bye is defined else false %}
{% set is_placeholder = match.get('is_placeholder') %}
{% set is_playable = match.get('is_playable') %}
{% set has_winner = match.get('winner') and not is_bye %}
<div class="m-match-item bracket-match {% if is_bye %}m-bye{% endif %} {% if is_placeholder %}m-placeholder{% endif %} {% if has_winner %}match-completed{% endif %} {{ extra_class }}"
     data-round="{{ match.round if match.round is defined else '' }}"
     data-match="{{ match.match_number }}"
     data-match-code="{{ match.match_code }}"
     data-bracket-type="{{ bracket_type }}"
     data-team1="{{ match.teams[0] }}"
     data-team2="{{ match.teams[1] }}">
    <div class="m-match-meta">
        <span class="m-match-code">{{ match.match_code }}</span>
        {% if is_playable %}<span>üü¢</span>
        {% elif has_winner %}<span>‚úì</span>{% endif %}
    </div>
    <div class="m-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
            {% if match.seeds is defined and match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
        </span>
        {% if not is_bye and not is_placeholder %}
        <div class="score-inputs" data-format="{{ scoring_format }}">
            {% if scoring_format == 'single_set' %}
            <input type="number" class="score-input" data-set="0" data-team="0"
                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                   min="0" max="99" placeholder="-">
            {% else %}
            {% for i in range(3) %}
            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                   min="0" max="99" placeholder="-">
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="m-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
            {% if match.seeds is defined and match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
        </span>
        {% if not is_bye and not is_placeholder %}
        <div class="score-inputs" data-format="{{ scoring_format }}">
            {% if scoring_format == 'single_set' %}
            <input type="number" class="score-input" data-set="0" data-team="1"
                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                   min="0" max="99" placeholder="-">
            {% else %}
            {% for i in range(3) %}
            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                   min="0" max="99" placeholder="-">
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% if is_bye %}<div class="m-bye-label">BYE</div>{% endif %}
    {% if match.get('losers_feed_to') and not is_bye %}
    <div class="m-bracket-feed">Loser ‚Üí {{ match.losers_feed_to }}</div>
    {% endif %}
    {% if match.get('note') %}<div class="m-match-note">{{ match.note }}</div>{% endif %}
</div>
{% endmacro %}

{# --- Macro: mobile grand final / bracket reset --- #}
{% macro mobile_final_match(match, scoring_format, bracket_type, label, is_conditional=false) %}
{% set is_placeholder = match.get('is_placeholder') %}
{% set is_playable = match.get('is_playable') %}
{% set has_winner = match.get('winner') %}
{% set needs_reset = match.get('needs_reset', false) if is_conditional else true %}
<div class="m-match-item bracket-match {% if has_winner %}match-completed{% endif %} {% if not is_conditional %}m-grand-final{% else %}m-bracket-reset{% endif %}"
     data-round="{{ label }}"
     data-match="1"
     data-bracket-type="{{ bracket_type }}"
     data-team1="{{ match.teams[0] }}"
     data-team2="{{ match.teams[1] }}">
    <div class="m-match-meta">
        <span>{{ label }}{% if is_conditional %} <span class="m-conditional-badge">If Needed</span>{% endif %}</span>
        {% if is_playable and (not is_conditional or needs_reset) %}<span>üü¢</span>
        {% elif has_winner %}<span>‚úì</span>{% endif %}
    </div>
    <div class="m-match-row">
        <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
        {% if not is_placeholder and (not is_conditional or needs_reset) %}
        <div class="score-inputs" data-format="{{ scoring_format }}">
            {% if scoring_format == 'single_set' %}
            <input type="number" class="score-input" data-set="0" data-team="0"
                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                   min="0" max="99" placeholder="-">
            {% else %}
            {% for i in range(3) %}
            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                   min="0" max="99" placeholder="-">
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    <div class="m-match-row">
        <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
        {% if not is_placeholder and (not is_conditional or needs_reset) %}
        <div class="score-inputs" data-format="{{ scoring_format }}">
            {% if scoring_format == 'single_set' %}
            <input type="number" class="score-input" data-set="0" data-team="1"
                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                   min="0" max="99" placeholder="-">
            {% else %}
            {% for i in range(3) %}
            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                   min="0" max="99" placeholder="-">
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% if match.get('note') %}<div class="m-match-note">{{ match.note }}</div>{% endif %}
</div>
{% endmacro %}

{# --- Macro: mobile seeded teams list --- #}
{% macro mobile_seeds(seeded_teams) %}
<div class="m-seed-list">
    {% for team_name, seed, pool_name in seeded_teams %}
    <div class="m-seed-item">
        <span class="seed-number">#{{ seed }}</span>
        <span class="seed-team">{{ team_name }}</span>
        <span class="seed-pool">{{ pool_name }}</span>
    </div>
    {% endfor %}
</div>
{% endmacro %}

{% block content %}
<div class="page-header">
    <h1>üèÜ Double Elimination Bracket</h1>
    <div class="page-header-actions">
        {% if show_test_buttons %}<button type="button" class="btn btn-sm btn-secondary" onclick="generateRandomBracketResults()">Test</button>{% endif %}
    </div>
</div>
<p>Enter scores for playable matches. Winners advance and losers drop to losers bracket.</p>
<br>

{% if error %}
<div class="error-message">
    {{ error }}
</div>
{% elif bracket_data %}

<!-- Gold Bracket Section -->
<div class="bracket-tier gold-bracket">
<h2 class="bracket-tier-title desktop-only">ü•á Gold Bracket</h2>

{% if bracket_data.champion %}
<div class="champion-banner">
    üèÜ Gold Champion: <strong>{{ bracket_data.champion }}</strong>
</div>
{% endif %}

{# --- Mobile: hierarchical bracket view --- #}
<details class="m-drill-down m-bracket-parent mobile-only" open>
    <summary>ü•á Gold Bracket</summary>
    <div class="m-drill-down-content">
        <details class="m-drill-down">
            <summary>Seeded Teams</summary>
            <div class="m-drill-down-content">{{ mobile_seeds(bracket_data.seeded_teams) }}</div>
        </details>
        <details class="m-drill-down" open>
            <summary>üîµ Winners Bracket</summary>
            <div class="m-drill-down-content">
            {% for round_name, matches in bracket_data.winners_bracket.items() %}
            <div class="m-round-label">{{ round_name }}</div>
            {% for match in matches %}
            {{ mobile_bracket_match(match, scoring_format, 'winners', 'm-winners') }}
            {% endfor %}
            {% endfor %}
            </div>
        </details>
        <details class="m-drill-down">
            <summary>üî¥ Losers Bracket</summary>
            <div class="m-drill-down-content">
            {% for round_name, matches in bracket_data.losers_bracket.items() %}
            <div class="m-round-label">{{ round_name }}</div>
            {% for match in matches %}
            {{ mobile_bracket_match(match, scoring_format, 'losers', 'm-losers') }}
            {% endfor %}
            {% endfor %}
            </div>
        </details>
        {% if bracket_data.grand_final %}
        <details class="m-drill-down" open>
            <summary>üèÜ Grand Final</summary>
            <div class="m-drill-down-content">
            {{ mobile_final_match(bracket_data.grand_final, scoring_format, 'grand_final', 'Grand Final') }}
            {% if bracket_data.bracket_reset %}
            {{ mobile_final_match(bracket_data.bracket_reset, scoring_format, 'bracket_reset', 'Bracket Reset', true) }}
            {% endif %}
            </div>
        </details>
        {% endif %}
    </div>
</details>

<div class="bracket-section desktop-only">
    <h2>Seeded Teams</h2>
    <p class="section-note">Teams are seeded based on pool finish position. Placeholders shown until pool play completes.</p>
    <div class="seeded-teams-grid desktop-only">
        {% for team_name, seed, pool_name in bracket_data.seeded_teams %}
        <div class="seed-card">
            <span class="seed-number">#{{ seed }}</span>
            <span class="seed-team">{{ team_name }}</span>
            <span class="seed-pool">{{ pool_name }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="bracket-section desktop-only">
    <h2>üîµ Winners Bracket</h2>
    <p class="section-note">
        Teams that haven't lost yet. Losers drop to the Losers Bracket.
        <span class="legend-item playable-legend">üü¢ Ready to play</span>
        <span class="legend-item completed-legend">‚úì Completed</span>
    </p>

    {# --- Desktop: horizontal bracket rounds --- #}
    <div class="bracket-rounds desktop-only">
        {% for round_name, matches in bracket_data.winners_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match winners-match {% if match.is_bye %}bye-match{% endif %} {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('is_playable') %}playable-match{% endif %} {% if match.get('winner') and not match.is_bye %}completed-match{% endif %}"
                     data-round="{{ round_name }}"
                     data-match="{{ match.match_number }}"
                     data-match-code="{{ match.match_code }}"
                     data-bracket-type="winners"
                     data-team1="{{ match.teams[0] }}"
                     data-team2="{{ match.teams[1] }}">
                    <div class="match-header">
                        <span class="match-code">{{ match.match_code }}</span>
                        {% if match.get('is_playable') %}
                        <span class="playable-indicator">üü¢</span>
                        {% elif match.get('winner') and not match.is_bye %}
                        <span class="completed-indicator">‚úì</span>
                        {% endif %}
                    </div>
                    
                    <div class="bracket-match-team team-top {% if match.winner == match.teams[0] %}winner{% endif %}">
                        <span class="team-info">
                            {% if match.seeds %}
                            <span class="match-seed">({{ match.seeds[0] }})</span>
                            {% endif %}
                            <span class="team-name">{{ match.teams[0] }}</span>
                        </span>
                        {% if not match.is_bye and not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="0"
                                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="match-vs">vs</div>
                    
                    <div class="bracket-match-team team-bottom {% if match.winner == match.teams[1] %}winner{% endif %}">
                        <span class="team-info">
                            {% if match.seeds %}
                            <span class="match-seed">({{ match.seeds[1] }})</span>
                            {% endif %}
                            <span class="team-name">{{ match.teams[1] }}</span>
                        </span>
                        {% if not match.is_bye and not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="1"
                                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if match.is_bye %}
                    <div class="bye-indicator">BYE - Advances automatically</div>
                    {% endif %}
                    {% if match.get('losers_feed_to') and not match.is_bye %}
                    <div class="bracket-feed">Loser ‚Üí {{ match.losers_feed_to }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>


</div>

<div class="bracket-section losers-section desktop-only">
    <h2>üî¥ Losers Bracket</h2>
    <p class="section-note">Teams with one loss. One more loss means elimination.</p>

    {# --- Desktop: horizontal losers bracket rounds --- #}
    <div class="bracket-rounds desktop-only">
        {% for round_name, matches in bracket_data.losers_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match losers-match {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('is_playable') %}playable-match{% endif %} {% if match.get('winner') %}completed-match{% endif %}"
                     data-round="{{ round_name }}"
                     data-match="{{ match.match_number }}"
                     data-match-code="{{ match.match_code }}"
                     data-bracket-type="losers"
                     data-team1="{{ match.teams[0] }}"
                     data-team2="{{ match.teams[1] }}">
                    <div class="match-header">
                        <span class="match-code">{{ match.match_code }}</span>
                        {% if match.get('is_playable') %}
                        <span class="playable-indicator">üü¢</span>
                        {% elif match.get('winner') %}
                        <span class="completed-indicator">‚úì</span>
                        {% endif %}
                    </div>
                    
                    <div class="bracket-match-team team-top {% if match.winner == match.teams[0] %}winner{% endif %}">
                        <span class="team-info">
                            <span class="team-name">{{ match.teams[0] }}</span>
                        </span>
                        {% if not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="0"
                                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="match-vs">vs</div>
                    
                    <div class="bracket-match-team team-bottom {% if match.winner == match.teams[1] %}winner{% endif %}">
                        <span class="team-info">
                            <span class="team-name">{{ match.teams[1] }}</span>
                        </span>
                        {% if not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="1"
                                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if match.get('note') %}
                    <div class="match-note">{{ match.note }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>


</div>

<div class="bracket-section finals-section desktop-only">
    <h2>üèÜ Grand Final</h2>
    <p class="section-note">Winners Bracket Champion vs Losers Bracket Champion</p>
    
    {% if bracket_data.grand_final %}
    {# --- Desktop: finals container --- #}
    <div class="finals-container desktop-only">
        <div class="bracket-match grand-final-match {% if bracket_data.grand_final.get('is_playable') %}playable-match{% endif %} {% if bracket_data.grand_final.get('winner') %}completed-match{% endif %}"
             data-round="Grand Final"
             data-match="1"
             data-bracket-type="grand_final"
             data-team1="{{ bracket_data.grand_final.teams[0] }}"
             data-team2="{{ bracket_data.grand_final.teams[1] }}">
            <div class="match-header">
                Grand Final
                {% if bracket_data.grand_final.get('is_playable') %}
                <span class="playable-indicator">üü¢</span>
                {% elif bracket_data.grand_final.get('winner') %}
                <span class="completed-indicator">‚úì</span>
                {% endif %}
            </div>
            
            <div class="bracket-match-team team-top {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[0] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ bracket_data.grand_final.teams[0] }}</span>
                </span>
                {% if not bracket_data.grand_final.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="0"
                           value="{{ bracket_data.grand_final.result.sets[0][0] if bracket_data.grand_final.result and bracket_data.grand_final.result.sets and bracket_data.grand_final.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                           value="{{ bracket_data.grand_final.result.sets[i][0] if bracket_data.grand_final.result and bracket_data.grand_final.result.sets and bracket_data.grand_final.result.sets|length > i and bracket_data.grand_final.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-vs">vs</div>
            
            <div class="bracket-match-team team-bottom {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[1] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ bracket_data.grand_final.teams[1] }}</span>
                </span>
                {% if not bracket_data.grand_final.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="1"
                           value="{{ bracket_data.grand_final.result.sets[0][1] if bracket_data.grand_final.result and bracket_data.grand_final.result.sets and bracket_data.grand_final.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                           value="{{ bracket_data.grand_final.result.sets[i][1] if bracket_data.grand_final.result and bracket_data.grand_final.result.sets and bracket_data.grand_final.result.sets|length > i and bracket_data.grand_final.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-note">{{ bracket_data.grand_final.note }}</div>
        </div>
        
        {% if bracket_data.bracket_reset %}
        <div class="bracket-match bracket-reset-match conditional-match {% if bracket_data.bracket_reset.get('needs_reset') and bracket_data.bracket_reset.get('is_playable') %}playable-match{% endif %} {% if bracket_data.bracket_reset.get('winner') %}completed-match{% endif %}"
             data-round="Bracket Reset"
             data-match="1"
             data-bracket-type="bracket_reset"
             data-team1="{{ bracket_data.bracket_reset.teams[0] }}"
             data-team2="{{ bracket_data.bracket_reset.teams[1] }}">
            <div class="match-header">Bracket Reset <span class="conditional-badge">If Needed</span>
                {% if bracket_data.bracket_reset.get('needs_reset') and bracket_data.bracket_reset.get('is_playable') %}
                <span class="playable-indicator">üü¢</span>
                {% elif bracket_data.bracket_reset.get('winner') %}
                <span class="completed-indicator">‚úì</span>
                {% endif %}
            </div>
            
            <div class="bracket-match-team team-top {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[0] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ bracket_data.bracket_reset.teams[0] }}</span>
                </span>
                {% if bracket_data.bracket_reset.get('needs_reset') and not bracket_data.bracket_reset.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="0"
                           value="{{ bracket_data.bracket_reset.result.sets[0][0] if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets and bracket_data.bracket_reset.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                           value="{{ bracket_data.bracket_reset.result.sets[i][0] if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets and bracket_data.bracket_reset.result.sets|length > i and bracket_data.bracket_reset.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-vs">vs</div>
            
            <div class="bracket-match-team team-bottom {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[1] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ bracket_data.bracket_reset.teams[1] }}</span>
                </span>
                {% if bracket_data.bracket_reset.get('needs_reset') and not bracket_data.bracket_reset.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="1"
                           value="{{ bracket_data.bracket_reset.result.sets[0][1] if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets and bracket_data.bracket_reset.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                           value="{{ bracket_data.bracket_reset.result.sets[i][1] if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets and bracket_data.bracket_reset.result.sets|length > i and bracket_data.bracket_reset.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-note">{{ bracket_data.bracket_reset.note }}</div>
        </div>
        {% endif %}
    </div>

    {% endif %}
</div>

</div><!-- end gold-bracket -->

<!-- Silver Bracket Section -->
{% if silver_bracket_enabled and silver_bracket_data %}
<div class="bracket-tier silver-bracket">
<h2 class="bracket-tier-title desktop-only">ü•à Silver Bracket</h2>

{% if silver_bracket_data.champion %}
<div class="champion-banner silver-champion">
    ü•à Silver Champion: <strong>{{ silver_bracket_data.champion }}</strong>
</div>
{% endif %}

{# --- Mobile: hierarchical silver bracket view --- #}
<details class="m-drill-down m-bracket-parent mobile-only">
    <summary>ü•à Silver Bracket</summary>
    <div class="m-drill-down-content">
        <details class="m-drill-down">
            <summary>Seeded Teams</summary>
            <div class="m-drill-down-content">{{ mobile_seeds(silver_bracket_data.seeded_teams) }}</div>
        </details>
        <details class="m-drill-down" open>
            <summary>ü•à Winners Bracket</summary>
            <div class="m-drill-down-content">
            {% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
            <div class="m-round-label">{{ round_name }}</div>
            {% for match in matches %}
            {{ mobile_bracket_match(match, scoring_format, 'silver_winners', 'm-silver-winners') }}
            {% endfor %}
            {% endfor %}
            </div>
        </details>
        <details class="m-drill-down">
            <summary>ü•à Losers Bracket</summary>
            <div class="m-drill-down-content">
            {% for round_name, matches in silver_bracket_data.losers_bracket.items() %}
            <div class="m-round-label">{{ round_name }}</div>
            {% for match in matches %}
            {{ mobile_bracket_match(match, scoring_format, 'silver_losers', 'm-silver-losers') }}
            {% endfor %}
            {% endfor %}
            </div>
        </details>
        {% if silver_bracket_data.grand_final %}
        <details class="m-drill-down" open>
            <summary>ü•à Grand Final</summary>
            <div class="m-drill-down-content">
            {{ mobile_final_match(silver_bracket_data.grand_final, scoring_format, 'silver_grand_final', 'Silver Grand Final') }}
            {% if silver_bracket_data.bracket_reset %}
            {{ mobile_final_match(silver_bracket_data.bracket_reset, scoring_format, 'silver_bracket_reset', 'Silver Bracket Reset', true) }}
            {% endif %}
            </div>
        </details>
        {% endif %}
    </div>
</details>

<div class="bracket-section desktop-only">
    <h2>Seeded Teams</h2>
    <p class="section-note">Teams that didn't advance from pool play compete in the Silver Bracket.</p>
    <div class="seeded-teams-grid desktop-only">
        {% for team_name, seed, pool_name in silver_bracket_data.seeded_teams %}
        <div class="seed-card">
            <span class="seed-number">#{{ seed }}</span>
            <span class="seed-team">{{ team_name }}</span>
            <span class="seed-pool">{{ pool_name }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Silver Winners Bracket -->
<div class="bracket-section desktop-only">
    <h2>ü•à Silver Winners Bracket</h2>

    {# --- Desktop --- #}
    <div class="bracket-rounds desktop-only">
        {% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match {% if match.is_bye %}bye-match{% endif %} {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('is_playable') %}playable-match{% endif %} {% if match.get('winner') and not match.is_bye %}completed-match{% endif %}"
                     data-round="{{ round_name }}"
                     data-match="{{ match.match_number }}"
                     data-match-code="{{ match.match_code }}"
                     data-bracket-type="silver_winners"
                     data-team1="{{ match.teams[0] }}"
                     data-team2="{{ match.teams[1] }}">
                    <div class="match-header">
                        <span class="match-code">{{ match.match_code }}</span>
                        {% if match.get('is_playable') %}
                        <span class="playable-indicator">üü¢</span>
                        {% elif match.get('winner') and not match.is_bye %}
                        <span class="completed-indicator">‚úì</span>
                        {% endif %}
                    </div>
                    
                    <div class="bracket-match-team team-top {% if match.winner == match.teams[0] %}winner{% endif %}">
                        <span class="team-info">
                            {% if match.seeds %}
                            <span class="match-seed">({{ match.seeds[0] }})</span>
                            {% endif %}
                            <span class="team-name">{{ match.teams[0] }}</span>
                        </span>
                        {% if not match.is_bye and not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="0"
                                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="match-vs">vs</div>
                    
                    <div class="bracket-match-team team-bottom {% if match.winner == match.teams[1] %}winner{% endif %}">
                        <span class="team-info">
                            {% if match.seeds %}
                            <span class="match-seed">({{ match.seeds[1] }})</span>
                            {% endif %}
                            <span class="team-name">{{ match.teams[1] }}</span>
                        </span>
                        {% if not match.is_bye and not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="1"
                                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if match.is_bye %}
                    <div class="bye-indicator">BYE - Advances automatically</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>


</div>

<!-- Silver Losers Bracket -->
<div class="bracket-section desktop-only">
    <h2>ü•à Silver Losers Bracket</h2>

    {# --- Desktop --- #}
    <div class="bracket-rounds desktop-only">
        {% for round_name, matches in silver_bracket_data.losers_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match {% if match.get('is_placeholder') %}placeholder-match{% endif %} {% if match.get('is_playable') %}playable-match{% endif %} {% if match.get('winner') %}completed-match{% endif %}"
                     data-round="{{ round_name }}"
                     data-match="{{ match.match_number }}"
                     data-match-code="{{ match.match_code }}"
                     data-bracket-type="silver_losers"
                     data-team1="{{ match.teams[0] }}"
                     data-team2="{{ match.teams[1] }}">
                    <div class="match-header">
                        <span class="match-code">{{ match.match_code }}</span>
                        {% if match.get('is_playable') %}
                        <span class="playable-indicator">üü¢</span>
                        {% elif match.get('winner') %}
                        <span class="completed-indicator">‚úì</span>
                        {% endif %}
                    </div>
                    
                    <div class="bracket-match-team team-top {% if match.winner == match.teams[0] %}winner{% endif %}">
                        <span class="team-info">
                            <span class="team-name">{{ match.teams[0] }}</span>
                        </span>
                        {% if not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="0"
                                   value="{{ match.result.sets[0][0] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                                   value="{{ match.result.sets[i][0] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="match-vs">vs</div>
                    
                    <div class="bracket-match-team team-bottom {% if match.winner == match.teams[1] %}winner{% endif %}">
                        <span class="team-info">
                            <span class="team-name">{{ match.teams[1] }}</span>
                        </span>
                        {% if not match.get('is_placeholder') %}
                        <div class="score-inputs" data-format="{{ scoring_format }}">
                            {% if scoring_format == 'single_set' %}
                            <input type="number" class="score-input" data-set="0" data-team="1"
                                   value="{{ match.result.sets[0][1] if match.result and match.result.sets and match.result.sets[0] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% else %}
                            {% for i in range(3) %}
                            <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                                   value="{{ match.result.sets[i][1] if match.result and match.result.sets and match.result.sets|length > i and match.result.sets[i] else '' }}"
                                   min="0" max="99" placeholder="-">
                            {% endfor %}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>


</div>

<!-- Silver Grand Final -->
{% if silver_bracket_data.grand_final %}
<div class="bracket-section desktop-only">
    <h2>ü•à Silver Grand Final</h2>

    {# --- Desktop --- #}
    <div class="grand-final-container desktop-only">
        <div class="bracket-match grand-final-match {% if silver_bracket_data.grand_final.get('is_placeholder') %}placeholder-match{% endif %} {% if silver_bracket_data.grand_final.get('is_playable') %}playable-match{% endif %} {% if silver_bracket_data.grand_final.get('winner') %}completed-match{% endif %}"
             data-round="Grand Final"
             data-match="1"
             data-bracket-type="silver_grand_final"
             data-team1="{{ silver_bracket_data.grand_final.teams[0] }}"
             data-team2="{{ silver_bracket_data.grand_final.teams[1] }}">
            <div class="match-header">
                Grand Final
                {% if silver_bracket_data.grand_final.get('is_playable') %}
                <span class="playable-indicator">üü¢</span>
                {% elif silver_bracket_data.grand_final.get('winner') %}
                <span class="completed-indicator">‚úì</span>
                {% endif %}
            </div>
            
            <div class="bracket-match-team team-top {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[0] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ silver_bracket_data.grand_final.teams[0] }}</span>
                    <span class="bracket-origin">(Winners Bracket)</span>
                </span>
                {% if not silver_bracket_data.grand_final.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="0"
                           value="{{ silver_bracket_data.grand_final.result.sets[0][0] if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets and silver_bracket_data.grand_final.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                           value="{{ silver_bracket_data.grand_final.result.sets[i][0] if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets and silver_bracket_data.grand_final.result.sets|length > i and silver_bracket_data.grand_final.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-vs">vs</div>
            
            <div class="bracket-match-team team-bottom {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[1] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ silver_bracket_data.grand_final.teams[1] }}</span>
                    <span class="bracket-origin">(Losers Bracket)</span>
                </span>
                {% if not silver_bracket_data.grand_final.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="1"
                           value="{{ silver_bracket_data.grand_final.result.sets[0][1] if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets and silver_bracket_data.grand_final.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                           value="{{ silver_bracket_data.grand_final.result.sets[i][1] if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets and silver_bracket_data.grand_final.result.sets|length > i and silver_bracket_data.grand_final.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>


</div>

{% if silver_bracket_data.bracket_reset %}
<div class="bracket-section desktop-only">

    {# --- Desktop --- #}
    <div class="finals-container desktop-only">
        <div class="bracket-match bracket-reset-match conditional-match {% if silver_bracket_data.bracket_reset.get('needs_reset') and silver_bracket_data.bracket_reset.get('is_playable') %}playable-match{% endif %} {% if silver_bracket_data.bracket_reset.get('winner') %}completed-match{% endif %}"
             data-round="Bracket Reset"
             data-match="1"
             data-bracket-type="silver_bracket_reset"
             data-team1="{{ silver_bracket_data.bracket_reset.teams[0] }}"
             data-team2="{{ silver_bracket_data.bracket_reset.teams[1] }}">
            <div class="match-header">Silver Bracket Reset <span class="conditional-badge">If Needed</span>
                {% if silver_bracket_data.bracket_reset.get('needs_reset') and silver_bracket_data.bracket_reset.get('is_playable') %}
                <span class="playable-indicator">üü¢</span>
                {% elif silver_bracket_data.bracket_reset.get('winner') %}
                <span class="completed-indicator">‚úì</span>
                {% endif %}
            </div>
            
            <div class="bracket-match-team team-top {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[0] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ silver_bracket_data.bracket_reset.teams[0] }}</span>
                </span>
                {% if silver_bracket_data.bracket_reset.get('needs_reset') and not silver_bracket_data.bracket_reset.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="0"
                           value="{{ silver_bracket_data.bracket_reset.result.sets[0][0] if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets and silver_bracket_data.bracket_reset.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="0"
                           value="{{ silver_bracket_data.bracket_reset.result.sets[i][0] if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets and silver_bracket_data.bracket_reset.result.sets|length > i and silver_bracket_data.bracket_reset.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
            
            <div class="match-vs">vs</div>
            
            <div class="bracket-match-team team-bottom {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[1] %}winner{% endif %}">
                <span class="team-info">
                    <span class="team-name">{{ silver_bracket_data.bracket_reset.teams[1] }}</span>
                </span>
                {% if silver_bracket_data.bracket_reset.get('needs_reset') and not silver_bracket_data.bracket_reset.get('is_placeholder') %}
                <div class="score-inputs" data-format="{{ scoring_format }}">
                    {% if scoring_format == 'single_set' %}
                    <input type="number" class="score-input" data-set="0" data-team="1"
                           value="{{ silver_bracket_data.bracket_reset.result.sets[0][1] if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets and silver_bracket_data.bracket_reset.result.sets[0] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% else %}
                    {% for i in range(3) %}
                    <input type="number" class="score-input" data-set="{{ i }}" data-team="1"
                           value="{{ silver_bracket_data.bracket_reset.result.sets[i][1] if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets and silver_bracket_data.bracket_reset.result.sets|length > i and silver_bracket_data.bracket_reset.result.sets[i] else '' }}"
                           min="0" max="99" placeholder="-">
                    {% endfor %}
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>
{% endif %}
{% endif %}

</div><!-- end silver-bracket -->
{% endif %}

{% else %}
<div class="empty-state">
    <p>No bracket data available. Please configure pools and teams first.</p>
    <a href="{{ url_for('teams') }}" class="btn btn-primary">Manage Teams</a>
</div>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const bracketMatches = document.querySelectorAll('.bracket-match:not(.bye-match):not(.placeholder-match)');
    
    bracketMatches.forEach(match => {
        const inputs = match.querySelectorAll('.score-input');
        let saveTimeout;
        
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => saveBracketResult(match), 500);
            });
        });
    });
    
    function saveBracketResult(match) {
        const team1 = match.dataset.team1;
        const team2 = match.dataset.team2;
        const round = match.dataset.round;
        const matchNumber = parseInt(match.dataset.match);
        const bracketType = match.dataset.bracketType || 'winners';
        
        let team1Inputs = match.querySelectorAll('.team-top .score-input');
        let team2Inputs = match.querySelectorAll('.team-bottom .score-input');
        
        // Fallback for mobile layout which uses .m-match-row instead of .team-top/.team-bottom
        if (team1Inputs.length === 0) {
            const rows = match.querySelectorAll('.m-match-row');
            if (rows.length >= 2) {
                team1Inputs = rows[0].querySelectorAll('.score-input');
                team2Inputs = rows[1].querySelectorAll('.score-input');
            }
        }
        
        const sets = [];
        const numSets = team1Inputs.length;
        
        for (let i = 0; i < numSets; i++) {
            const score1 = team1Inputs[i].value ? parseInt(team1Inputs[i].value) : null;
            const score2 = team2Inputs[i].value ? parseInt(team2Inputs[i].value) : null;
            
            if (score1 !== null || score2 !== null) {
                sets.push([score1, score2]);
            }
        }
        
        fetch('/api/results/bracket', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                team1: team1,
                team2: team2,
                round: round,
                match_number: matchNumber,
                bracket_type: bracketType,
                sets: sets
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Refresh page to update bracket advancement
                if (data.winner) {
                    location.reload();
                }
            }
        })
        .catch(error => console.error('Error saving result:', error));
    }
});

function generateRandomBracketResults() {
    fetch('/api/generate-random-bracket-results', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}
</script>
{% endblock %}
