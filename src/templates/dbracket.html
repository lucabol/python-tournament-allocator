{% extends "base.html" %}

{% block title %}Double Elimination Bracket - Tournament Allocator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üèÜ Double Elimination Bracket</h1>
    <p>Preview of the double elimination bracket based on pool advancement settings</p>
</div>

{% if error %}
<div class="error-message">
    {{ error }}
</div>
{% elif bracket_data %}

<div class="bracket-stats">
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.total_teams }}</div>
        <div class="stat-label">Teams Advancing</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.bracket_size }}</div>
        <div class="stat-label">Bracket Size</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.total_winners_rounds }}</div>
        <div class="stat-label">Winners Rounds</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.total_losers_rounds }}</div>
        <div class="stat-label">Losers Rounds</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.byes }}</div>
        <div class="stat-label">First Round Byes</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ bracket_data.total_matches }}</div>
        <div class="stat-label">Total Matches</div>
    </div>
</div>

<div class="bracket-section">
    <h2>Seeded Teams</h2>
    <p class="section-note">Teams are seeded based on pool finish position. Placeholders shown until pool play completes.</p>
    <div class="seeded-teams-grid">
        {% for team_name, seed, pool_name in bracket_data.seeded_teams %}
        <div class="seed-card">
            <span class="seed-number">#{{ seed }}</span>
            <span class="seed-team">{{ team_name }}</span>
            <span class="seed-pool">{{ pool_name }}</span>
        </div>
        {% endfor %}
    </div>
</div>

<div class="bracket-section">
    <h2>üîµ Winners Bracket</h2>
    <p class="section-note">Teams that haven't lost yet. Losers drop to the Losers Bracket.</p>
    <div class="bracket-rounds">
        {% for round_name, matches in bracket_data.winners_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match winners-match {% if match.is_bye %}bye-match{% endif %} {% if match.get('is_placeholder') %}placeholder-match{% endif %}">
                    <div class="match-header">Match {{ match.match_number }}</div>
                    <div class="match-team team-top">
                        {% if match.seeds %}
                        <span class="match-seed">({{ match.seeds[0] }})</span>
                        {% endif %}
                        {{ match.teams[0] }}
                    </div>
                    <div class="match-vs">vs</div>
                    <div class="match-team team-bottom">
                        {% if match.seeds %}
                        <span class="match-seed">({{ match.seeds[1] }})</span>
                        {% endif %}
                        {{ match.teams[1] }}
                    </div>
                    {% if match.is_bye %}
                    <div class="bye-indicator">BYE - Advances automatically</div>
                    {% endif %}
                    {% if match.get('losers_feed_to') %}
                    <div class="bracket-feed">Loser ‚Üí {{ match.losers_feed_to }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="bracket-section losers-section">
    <h2>üî¥ Losers Bracket</h2>
    <p class="section-note">Teams with one loss. One more loss means elimination.</p>
    <div class="bracket-rounds">
        {% for round_name, matches in bracket_data.losers_bracket.items() %}
        <div class="round-column">
            <h3>{{ round_name }}</h3>
            <div class="round-matches">
                {% for match in matches %}
                <div class="bracket-match losers-match {% if match.get('is_placeholder') %}placeholder-match{% endif %}">
                    <div class="match-header">Match {{ match.match_number }}</div>
                    <div class="match-team team-top">{{ match.teams[0] }}</div>
                    <div class="match-vs">vs</div>
                    <div class="match-team team-bottom">{{ match.teams[1] }}</div>
                    {% if match.get('note') %}
                    <div class="match-note">{{ match.note }}</div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="bracket-section finals-section">
    <h2>üèÜ Grand Final</h2>
    <p class="section-note">Winners Bracket Champion vs Losers Bracket Champion</p>
    
    {% if bracket_data.grand_final %}
    <div class="finals-container">
        <div class="bracket-match grand-final-match">
            <div class="match-header">Grand Final</div>
            <div class="match-team team-top">{{ bracket_data.grand_final.teams[0] }}</div>
            <div class="match-vs">vs</div>
            <div class="match-team team-bottom">{{ bracket_data.grand_final.teams[1] }}</div>
            <div class="match-note">{{ bracket_data.grand_final.note }}</div>
        </div>
        
        {% if bracket_data.bracket_reset %}
        <div class="bracket-match bracket-reset-match conditional-match">
            <div class="match-header">Bracket Reset <span class="conditional-badge">If Needed</span></div>
            <div class="match-team team-top">{{ bracket_data.bracket_reset.teams[0] }}</div>
            <div class="match-vs">vs</div>
            <div class="match-team team-bottom">{{ bracket_data.bracket_reset.teams[1] }}</div>
            <div class="match-note">{{ bracket_data.bracket_reset.note }}</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="bracket-actions">
    <a href="{{ url_for('schedule_double_elimination') }}" class="btn btn-primary">Schedule Double Elimination Rounds</a>
</div>

{% else %}
<div class="empty-state">
    <p>No bracket data available. Please configure pools and teams first.</p>
    <a href="{{ url_for('teams') }}" class="btn btn-primary">Manage Teams</a>
</div>
{% endif %}
{% endblock %}
