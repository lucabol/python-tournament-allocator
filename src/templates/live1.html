<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#ffffff">
    <title>Live Tournament â€” Card View</title>
    <link rel="icon" href="/api/logo">
    <link rel="stylesheet" href="{{ url_for('static', filename='live1.css') }}">
</head>
<body>
    <header class="live-header">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            {% include '_tournament_header.html' %}
        </div>
        <div>
            <span class="sse-status">
                <span id="sse-dot" class="sse-dot disconnected"></span>
                <span id="sse-label">Connectingâ€¦</span>
            </span>
        </div>
    </header>

    <div class="team-filter-bar">
        <input type="search" id="team-filter" class="team-filter-input"
               placeholder="ðŸ” Find my teamâ€¦" autocomplete="off" spellcheck="false">
    </div>

    <main class="live-container" id="live-content">
{% include 'live1_content.html' %}
    </main>

    <footer class="live-footer">
        <p>Tournament Allocator &copy; 2026</p>
    </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var contentEl = document.getElementById('live-content');
    var dotEl = document.getElementById('sse-dot');
    var labelEl = document.getElementById('sse-label');
    var filterInput = document.getElementById('team-filter');

    function setStatus(state) {
        dotEl.className = 'sse-dot ' + state;
        labelEl.textContent = state === 'connected' ? 'Live' :
                              state === 'reconnecting' ? 'Reconnectingâ€¦' : 'Disconnected';
    }

    /* --- Team Filter --- */
    function applyFilter() {
        var query = filterInput.value.trim().toLowerCase();
        var items = contentEl.querySelectorAll('[data-teams]');
        items.forEach(function(el) {
            if (!query) {
                el.classList.remove('filter-hidden', 'filter-highlight');
                return;
            }
            var teams = el.getAttribute('data-teams').toLowerCase();
            if (teams.indexOf(query) !== -1) {
                el.classList.remove('filter-hidden');
                el.classList.add('filter-highlight');
            } else {
                el.classList.add('filter-hidden');
                el.classList.remove('filter-highlight');
            }
        });
    }

    filterInput.addEventListener('input', applyFilter);

    /* --- SSE --- */
    function fetchContent() {
        fetch('/api/live1-html')
            .then(function(r) { return r.text(); })
            .then(function(html) { contentEl.innerHTML = html; applyFilter(); })
            .catch(function(err) { console.error('Failed to fetch live content:', err); });
    }

    if (typeof EventSource === 'undefined') {
        setStatus('connected');
        labelEl.textContent = 'Polling (30s)';
        setInterval(fetchContent, 30000);
        return;
    }

    var source = new EventSource('/api/live-stream');
    source.addEventListener('open', function() { setStatus('connected'); });
    source.addEventListener('connected', function() { setStatus('connected'); });
    source.addEventListener('update', function() { fetchContent(); });
    source.addEventListener('error', function() {
        setStatus(source.readyState === EventSource.CONNECTING ? 'reconnecting' : 'disconnected');
    });
});
</script>
</body>
</html>
