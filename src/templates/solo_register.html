<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Player Registration - {{ tournament_name }}</title>
    <link rel="icon" href="/api/logo">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 1rem;
            color: #1e293b;
            line-height: 1.5;
        }
        
        .register-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 700px;
            width: 100%;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .register-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
        }
        
        .register-logo {
            max-width: 80px;
            max-height: 80px;
            margin: 0 auto 1rem;
            display: block;
            border-radius: 8px;
            background: white;
            padding: 0.5rem;
        }
        
        .register-header h1 {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }
        
        .tournament-meta {
            font-size: 0.875rem;
            opacity: 0.95;
            line-height: 1.6;
        }
        
        .tournament-meta-item {
            margin-bottom: 0.25rem;
        }
        
        .register-body {
            padding: 2rem 1.5rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.375rem;
            font-size: 0.875rem;
            color: #1e293b;
        }
        
        label .required {
            color: #dc2626;
        }
        
        label .optional {
            color: #64748b;
            font-weight: 400;
            font-size: 0.75rem;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-row {
            display: flex;
            gap: 1rem;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .btn {
            width: 100%;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-bottom: 1.25rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .message-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .message-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }
        
        .players-section {
            margin-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
            padding-top: 1.5rem;
        }
        
        .players-section h2 {
            font-size: 1.125rem;
            margin-bottom: 1rem;
            color: #1e293b;
        }
        
        .players-count {
            color: #64748b;
            font-weight: 400;
            font-size: 0.875rem;
        }
        
        .players-table-wrapper {
            overflow-x: auto;
        }
        
        .players-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        .players-table th {
            background: #f8fafc;
            padding: 0.625rem 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        
        .players-table th:hover {
            background: #f1f5f9;
        }
        
        .players-table th .sort-icon {
            margin-left: 0.25rem;
            opacity: 0.4;
        }
        
        .players-table th.sorted .sort-icon {
            opacity: 1;
        }
        
        .players-table td {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            color: #334155;
        }
        
        .players-table tr:hover {
            background: #f8fafc;
        }
        
        .delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #94a3b8;
            font-size: 1.125rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            line-height: 1;
        }
        
        .delete-btn:hover {
            color: #dc2626;
            background: #fee2e2;
        }
        
        .no-players {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
            font-style: italic;
        }
        
        .register-footer {
            padding: 1rem 1.5rem;
            background: #f8fafc;
            text-align: center;
            font-size: 0.75rem;
            color: #64748b;
            border-top: 1px solid #e2e8f0;
        }
        
        .qr-section {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .qr-section .qr-container {
            display: inline-block;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.2s;
        }
        
        .qr-section .qr-container:hover {
            background: #f1f5f9;
        }
        
        .qr-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.375rem;
        }
        
        @media (max-width: 600px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .register-header {
                padding: 1.5rem 1rem;
            }
            
            .register-header h1 {
                font-size: 1.5rem;
            }
            
            .register-body {
                padding: 1.5rem 1rem;
            }
            
            .players-table {
                font-size: 0.8125rem;
            }
            
            .players-table th, .players-table td {
                padding: 0.375rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="register-header">
            {% if logo_url %}
            <img src="{{ logo_url }}" alt="Logo" class="register-logo">
            {% endif %}
            <h1>{{ tournament_name }}</h1>
            <div class="tournament-meta">
                <div class="tournament-meta-item">Solo Player Registration</div>
                {% if organization_name %}
                <div class="tournament-meta-item">{{ organization_name }}</div>
                {% endif %}
                {% if tournament_dates %}
                <div class="tournament-meta-item">üìÖ {{ tournament_dates }}</div>
                {% endif %}
                {% if tournament_location %}
                <div class="tournament-meta-item">üìç {{ tournament_location }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="register-body">
            <div id="message-container"></div>
            
            <div class="qr-section">
                <div class="qr-container" id="qr-solo" onclick="copySoloLink()" title="Click to copy link">
                    <div id="qr-solo-container"></div>
                    <div class="qr-label">Share this page</div>
                </div>
                <p style="margin-top:1rem;font-size:0.9rem;color:#475569;text-align:center;line-height:1.6;">
                    Contact the other players directly to form a team and then click
                    <a href="/register/{{ username }}/{{ slug }}" style="color:#667eea;font-weight:600;text-decoration:underline;">here</a>
                    to register to the tournament.
                </p>
            </div>
            
            <form id="solo-form">
                <div class="form-group">
                    <label for="name">Name <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required maxlength="100" placeholder="Your name">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="language">Language <span class="optional">(optional)</span></label>
                        <input type="text" id="language" name="language" maxlength="50" placeholder="e.g. English, Italian">
                    </div>
                    
                    <div class="form-group">
                        <label for="sex">Sex <span class="optional">(optional)</span></label>
                        <select id="sex" name="sex">
                            <option value="">-- Select --</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="age_group">Age Group <span class="optional">(optional)</span></label>
                        <select id="age_group" name="age_group">
                            <option value="">-- Select --</option>
                            <option value="< 20">< 20</option>
                            <option value="20 - 29">20 - 29</option>
                            <option value="30 - 39">30 - 39</option>
                            <option value="40 - 49">40 - 49</option>
                            <option value="50 - 59">50 - 59</option>
                            <option value="> 60">> 60</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="telephone">Telephone <span class="optional">(optional)</span></label>
                        <input type="tel" id="telephone" name="telephone" maxlength="50" placeholder="+1 234 567 8900">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email <span class="optional">(optional)</span></label>
                        <input type="email" id="email" name="email" maxlength="100" placeholder="your@email.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="comment">Comment <span class="optional">(optional)</span></label>
                    <textarea id="comment" name="comment" maxlength="300" rows="2" placeholder="Any additional info..."></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    Register
                </button>
            </form>
            
            <div class="players-section">
                <h2>Registered Players <span class="players-count" id="players-count">({{ solo_players|length }})</span></h2>
                
                <div class="players-table-wrapper">
                    <table class="players-table" id="players-table">
                        <thead>
                            <tr>
                                <th data-sort="name">Name <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="language">Language <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="sex">Sex <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="age_group">Age <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="telephone">Phone <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="email">Email <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="comment">Comment <span class="sort-icon">‚Üï</span></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="players-tbody">
                        </tbody>
                    </table>
                    <div class="no-players" id="no-players" style="display: none;">
                        No players registered yet. Be the first!
                    </div>
                </div>
            </div>
        </div>
        
        <div class="register-footer">
            Powered by Tournament Allocator
        </div>
    </div>
    
    <script>
        let players = {{ solo_players | tojson }};
        let sortField = null;
        let sortAsc = true;
        
        function renderPlayers() {
            const tbody = document.getElementById('players-tbody');
            const noPlayers = document.getElementById('no-players');
            const countEl = document.getElementById('players-count');
            
            countEl.textContent = '(' + players.length + ')';
            
            if (players.length === 0) {
                tbody.innerHTML = '';
                noPlayers.style.display = 'block';
                return;
            }
            noPlayers.style.display = 'none';
            
            let sorted = [...players];
            if (sortField) {
                sorted.sort((a, b) => {
                    const va = (a[sortField] || '').toString().toLowerCase();
                    const vb = (b[sortField] || '').toString().toLowerCase();
                    if (va < vb) return sortAsc ? -1 : 1;
                    if (va > vb) return sortAsc ? 1 : -1;
                    return 0;
                });
            }
            
            tbody.innerHTML = sorted.map((p, displayIdx) => {
                const origIdx = players.indexOf(p);
                return '<tr>' +
                    '<td>' + esc(p.name) + '</td>' +
                    '<td>' + esc(p.language || '') + '</td>' +
                    '<td>' + esc(p.sex || '') + '</td>' +
                    '<td>' + esc(p.age_group || '') + '</td>' +
                    '<td>' + esc(p.telephone || '') + '</td>' +
                    '<td>' + esc(p.email || '') + '</td>' +
                    '<td>' + esc(p.comment || '') + '</td>' +
                    '<td><button class="delete-btn" onclick="deletePlayer(' + origIdx + ')" title="Remove">‚úï</button></td>' +
                '</tr>';
            }).join('');
            
            // Update sort header styling
            document.querySelectorAll('.players-table th').forEach(th => {
                th.classList.remove('sorted');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.textContent = '‚Üï';
            });
            if (sortField) {
                const th = document.querySelector('[data-sort="' + sortField + '"]');
                if (th) {
                    th.classList.add('sorted');
                    const icon = th.querySelector('.sort-icon');
                    if (icon) icon.textContent = sortAsc ? '‚Üë' : '‚Üì';
                }
            }
        }
        
        function esc(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Sort on header click
        document.querySelectorAll('.players-table th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (sortField === field) {
                    sortAsc = !sortAsc;
                } else {
                    sortField = field;
                    sortAsc = true;
                }
                renderPlayers();
            });
        });
        
        async function deletePlayer(idx) {
            if (!confirm('Remove this player?')) return;
            
            try {
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'delete', index: idx })
                });
                const result = await response.json();
                if (result.success) {
                    players = result.players;
                    renderPlayers();
                } else {
                    alert(result.error || 'Failed to delete.');
                }
            } catch (e) {
                alert('Network error.');
            }
        }
        
        // Form submission
        document.getElementById('solo-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submit-btn');
            const msgContainer = document.getElementById('message-container');
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';
            msgContainer.innerHTML = '';
            
            const formData = {
                name: document.getElementById('name').value.trim(),
                language: document.getElementById('language').value.trim(),
                sex: document.getElementById('sex').value,
                age_group: document.getElementById('age_group').value,
                telephone: document.getElementById('telephone').value.trim(),
                email: document.getElementById('email').value.trim(),
                comment: document.getElementById('comment').value.trim()
            };
            
            try {
                const response = await fetch(window.location.pathname, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                
                if (result.success) {
                    msgContainer.innerHTML = '<div class="message message-success">‚úì Registered successfully!</div>';
                    players = result.players;
                    renderPlayers();
                    this.reset();
                    setTimeout(() => { msgContainer.innerHTML = ''; }, 3000);
                } else {
                    msgContainer.innerHTML = '<div class="message message-error">‚úï ' + (result.error || 'Registration failed.') + '</div>';
                }
            } catch (e) {
                msgContainer.innerHTML = '<div class="message message-error">‚úï Network error. Please try again.</div>';
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Register';
        });
        
        // QR code and copy link
        const soloUrl = window.location.href;
        const qrSoloContainer = document.getElementById('qr-solo-container');
        if (qrSoloContainer && typeof QRCode !== 'undefined') {
            new QRCode(qrSoloContainer, {
                text: soloUrl,
                width: 80,
                height: 80,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.M
            });
        }
        
        // Initial render
        renderPlayers();
        
        function copySoloLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                const label = document.querySelector('.qr-label');
                const orig = label.textContent;
                label.textContent = 'Link copied!';
                setTimeout(() => { label.textContent = orig; }, 2000);
            });
        }
    </script>
</body>
</html>
