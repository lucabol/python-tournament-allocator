{# Live Content: Smart Summary + Drill-Down
   ‚Äî "Up Next" hero at top (one match per court), everything else in collapsible <details> sections #}

{% if not pools %}
<div class="empty-state">
    <h2>Tournament Not Started</h2>
    <p>No teams have been configured yet.</p>
</div>
{% else %}

{# --- Champion Banners --- #}
{% if bracket_data and bracket_data.champion %}
<div class="champion-banner">üèÜ Gold Champion: <strong>{{ bracket_data.champion }}</strong></div>
{% endif %}
{% if silver_bracket_data and silver_bracket_data.champion %}
<div class="champion-banner silver-champion">ü•à Silver Champion: <strong>{{ silver_bracket_data.champion }}</strong></div>
{% endif %}

{# ============ UP NEXT (one match per court) ============ #}
{# Hide entirely when the tournament is finished (champion crowned) #}
{% if schedule and not (bracket_data and bracket_data.champion) %}
<div class="now-playing-hero">
    <div class="hero-title"><span class="live-dot"></span> Up Next</div>

    {# Build ordered list of (day_key, day_data) entries ‚Äî pool days first, then bracket #}
    {% set pool_days = schedule.keys() | reject('equalto', 'Bracket Phase') | list %}
    {% set all_days = [] %}
    {% for day in pool_days %}
        {% if all_days.append((day, schedule[day])) %}{% endif %}
    {% endfor %}
    {% if 'Bracket Phase' in schedule %}
        {% if all_days.append(('Bracket Phase', schedule['Bracket Phase'])) %}{% endif %}
    {% endif %}

    {# Collect unique court names in order of first appearance #}
    {% set all_courts = [] %}
    {% for day_key, day_data in all_days %}
        {% for court_name in day_data.keys() | reject('equalto', '_time_slots') | list %}
            {% if court_name not in all_courts %}
                {% if all_courts.append(court_name) %}{% endif %}
            {% endif %}
        {% endfor %}
    {% endfor %}

    {# For each court, find the first non-completed match across all days #}
    {% for court_name in all_courts %}
    {% set court_ns = namespace(next_match=none, next_time=none, next_pool=none, next_round=none, is_bracket=false) %}
    {% for day_key, day_data in all_days %}
        {% if court_ns.next_match is none and court_name in day_data %}
            {% for time_slot in day_data['_time_slots'] %}
                {% if court_ns.next_match is none and time_slot in day_data[court_name]['time_to_match'] %}
                    {% set match = day_data[court_name]['time_to_match'][time_slot] %}
                    {# Check completion: pool play uses results dict, bracket uses match.result #}
                    {% if day_key == 'Bracket Phase' %}
                        {% set match_result = match.get('result', {}) %}
                        {% set is_completed = match_result.get('completed', false) %}
                        {% if not is_completed and not match.get('is_placeholder') %}
                            {% set court_ns.next_match = match %}
                            {% set court_ns.next_time = time_slot %}
                            {% set court_ns.next_round = match.round if match.round else '' %}
                            {% set court_ns.is_bracket = true %}
                        {% endif %}
                    {% else %}
                        {% set team1 = match.teams[0] %}
                        {% set team2 = match.teams[1] %}
                        {% set match_key_check = [team1, team2]|sort|join('_vs_') %}
                        {% set pool_name = match.pool if match.pool else '' %}
                        {% set full_match_key = match_key_check ~ '_' ~ pool_name if pool_name else match_key_check %}
                        {% set match_result = results.get(full_match_key, {}) %}
                        {% set is_completed = match_result.get('completed', false) %}
                        {% if not is_completed %}
                            {% set court_ns.next_match = match %}
                            {% set court_ns.next_time = time_slot %}
                            {% set court_ns.next_pool = pool_name %}
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}

    {% if court_ns.next_match is not none %}
    {% set m = court_ns.next_match %}
    {% set team1 = m.teams[0] %}
    {% set team2 = m.teams[1] %}
    {% if (court_ns.is_bracket or m.get('is_bracket')) and m.get('match_code') %}
        {% set full_match_key = m.match_code %}
        {% set pool_name = m.get('pool', '') %}
    {% else %}
        {% set match_key_check = [team1, team2]|sort|join('_vs_') %}
        {% set pool_name = court_ns.next_pool if court_ns.next_pool else '' %}
        {% set full_match_key = match_key_check ~ '_' ~ pool_name if pool_name else match_key_check %}
    {% endif %}
    <div class="hero-match-card" data-teams="{{ team1 }} {{ team2 }}" 
         data-match-key="{{ full_match_key }}" data-team1="{{ team1 }}" data-team2="{{ team2 }}" data-pool="{{ pool_name }}"
         {% if m.get('match_code') %}data-match-code="{{ m.match_code }}"{% endif %}>
        <div class="hero-match-meta">
            <span class="meta-time">{{ court_ns.next_time }}</span>
            <span class="meta-court">{{ court_name }}</span>
            {% if court_ns.is_bracket and court_ns.next_round %}
                <span class="meta-pool">{{ court_ns.next_round }}</span>
            {% elif court_ns.next_pool %}
                <span class="meta-pool">{{ court_ns.next_pool }}</span>
            {% endif %}
            <button class="btn-report-score" onclick="toggleReportForm(this)" title="Report score">üìù Report</button>
        </div>
        <div class="hero-match-row">
            <span class="team-name">{{ team1 }}</span>
            <span class="hero-score">-</span>
        </div>
        <div class="hero-match-row">
            <span class="team-name">{{ team2 }}</span>
            <span class="hero-score">-</span>
        </div>
    </div>
    {% else %}
    <div class="hero-match-card court-done" data-teams="">
        <div class="hero-match-meta">
            <span class="meta-court">{{ court_name }}</span>
        </div>
        <p class="empty-note">All matches completed ‚úì</p>
    </div>
    {% endif %}
    {% endfor %}

    {% if all_courts | length == 0 %}
    <p class="empty-note">No matches scheduled.</p>
    {% endif %}
</div>
{% endif %}

{# ============ FULL SCHEDULE (collapsed) ============ #}
{% if schedule %}
<details class="drill-down-section">
    <summary>üìÖ Full Schedule</summary>
    <div class="drill-down-content">
        {% set pool_days = schedule.keys() | reject('equalto', 'Bracket Phase') | list %}
        {% for day in pool_days %}
        {% set day_data = schedule[day] %}
        <h4 class="bracket-round-label">{{ day }}</h4>
        {% set time_slots = day_data['_time_slots'] %}
        {% set courts = day_data.keys() | reject('equalto', '_time_slots') | list %}
        {% for time_slot in time_slots %}
        {% for court_name in courts %}
        {% if time_slot in day_data[court_name]['time_to_match'] %}
        {% set match = day_data[court_name]['time_to_match'][time_slot] %}
        {% set team1 = match.teams[0] %}
        {% set team2 = match.teams[1] %}
        {% if match.get('is_bracket') and match.get('match_code') %}
            {% set full_match_key = match.match_code %}
            {% set pool_name = match.get('pool', '') %}
        {% else %}
            {% set match_key_check = [team1, team2]|sort|join('_vs_') %}
            {% set pool_name = match.pool if match.pool else '' %}
            {% set full_match_key = match_key_check ~ '_' ~ pool_name if pool_name else match_key_check %}
        {% endif %}
        {% set match_result = results.get(full_match_key, {}) %}
        {% set is_completed = match_result.get('completed', false) %}
        <div class="match-list-item {% if is_completed %}match-completed{% endif %}" data-teams="{{ team1 }} {{ team2 }}" 
             data-match-key="{{ full_match_key }}" data-team1="{{ team1 }}" data-team2="{{ team2 }}" data-pool="{{ pool_name }}"
             {% if match.get('match_code') %}data-match-code="{{ match.match_code }}"{% endif %}>
            <div class="match-list-meta">
                <span>{{ time_slot }} ¬∑ {{ court_name }}</span>
                {% if pool_name %}<span>{{ pool_name }}</span>{% endif %}
                {% if not is_completed %}
                <button class="btn-report-score" onclick="toggleReportForm(this)" title="Report score">üìù Report</button>
                {% endif %}
            </div>
            <div class="match-list-row">
                <span class="team-name {% if match_result.winner == team1 %}winner{% endif %}">{{ team1 }}</span>
                {% if match_result.sets %}
                <span class="list-score">{{ match_result.sets[0][0] if match_result.sets[0] else '-' }}</span>
                {% endif %}
            </div>
            <div class="match-list-row">
                <span class="team-name {% if match_result.winner == team2 %}winner{% endif %}">{{ team2 }}</span>
                {% if match_result.sets %}
                <span class="list-score">{{ match_result.sets[0][1] if match_result.sets[0] else '-' }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% endfor %}

        {# Bracket phase schedule #}
        {% if 'Bracket Phase' in schedule %}
        <h4 class="bracket-round-label">Bracket Phase</h4>
        {% set bracket_day_data = schedule['Bracket Phase'] %}
        {% set bracket_time_slots = bracket_day_data['_time_slots'] %}
        {% set bracket_courts = bracket_day_data.keys() | reject('equalto', '_time_slots') | list %}
        {% for time_slot in bracket_time_slots %}
        {% for court_name in bracket_courts %}
        {% if time_slot in bracket_day_data[court_name]['time_to_match'] %}
        {% set match = bracket_day_data[court_name]['time_to_match'][time_slot] %}
        {% set team1 = match.teams[0] %}
        {% set team2 = match.teams[1] %}
        {% set match_result = match.get('result', {}) %}
        {% set is_completed = match_result.get('completed', false) %}
        {% set bracket_match_key = match.get('match_code', '') %}
        {% set bracket_pool = match.get('pool', '') %}
        <div class="match-list-item {% if is_completed %}match-completed{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %}" data-teams="{{ team1 }} {{ team2 }}"
             data-match-key="{{ bracket_match_key }}" data-team1="{{ team1 }}" data-team2="{{ team2 }}" data-pool="{{ bracket_pool }}"
             data-match-code="{{ bracket_match_key }}">
            <div class="match-list-meta">
                <span>{{ time_slot }} ¬∑ {{ court_name }}</span>
                {% if match.round %}<span>{{ match.round }}</span>{% endif %}
                {% if not is_completed and not match.get('is_placeholder') %}
                <button class="btn-report-score" onclick="toggleReportForm(this)" title="Report score">üìù Report</button>
                {% endif %}
            </div>
            <div class="match-list-row">
                <span class="team-name {% if match_result.winner == team1 %}winner{% endif %}">{{ team1 }}</span>
                {% if match_result.sets %}
                <span class="list-score">{{ match_result.sets[0][0] if match_result.sets[0] else '-' }}</span>
                {% endif %}
            </div>
            <div class="match-list-row">
                <span class="team-name {% if match_result.winner == team2 %}winner{% endif %}">{{ team2 }}</span>
                {% if match_result.sets %}
                <span class="list-score">{{ match_result.sets[0][1] if match_result.sets[0] else '-' }}</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% endfor %}
        {% endfor %}
        {% endif %}
    </div>
</details>
{% endif %}

{# ============ POOL STANDINGS (collapsed) ============ #}
<details class="drill-down-section">
    <summary>üìä Pool Standings</summary>
    <div class="drill-down-content">
        {% if standings %}
        {% for pool_name, team_list in standings.items() %}
        <div class="pool-card" data-teams="{{ team_list | map(attribute='team') | join(' ') }}">
            <h4>{{ pool_name }}</h4>
            <table class="live-standings-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Team</th>
                        <th>W</th>
                        <th>L</th>
                        <th>ŒîS</th>
                        <th>ŒîP</th>
                    </tr>
                </thead>
                <tbody>
                    {% for team in team_list %}
                    {% set advance_count = pools[pool_name].advance if pools and pool_name in pools else 2 %}
                    {% set has_played = team.matches_played > 0 %}
                    <tr class="{% if loop.index <= advance_count and has_played %}advancing{% endif %}">
                        <td>{{ loop.index }}</td>
                        <td>{{ team.team }}</td>
                        <td>{{ team.wins }}</td>
                        <td>{{ team.losses }}</td>
                        <td class="{% if team.set_diff > 0 %}stat-positive{% elif team.set_diff < 0 %}stat-negative{% endif %}">
                            {{ '+' if team.set_diff > 0 else '' }}{{ team.set_diff }}
                        </td>
                        <td class="{% if team.point_diff > 0 %}stat-positive{% elif team.point_diff < 0 %}stat-negative{% endif %}">
                            {{ '+' if team.point_diff > 0 else '' }}{{ team.point_diff }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
        {% else %}
        <p class="empty-note">No pool results recorded yet.</p>
        {% endif %}
    </div>
</details>

{# ============ GOLD BRACKET (collapsed) ============ #}
{% if bracket_data %}
<details class="drill-down-section">
    <summary>ü•á Gold Bracket</summary>
    <div class="drill-down-content">
        {# Check if this is double elimination (has winners_bracket) or single elimination (has rounds) #}
        {% if bracket_data.winners_bracket %}
            {# Double Elimination Format #}
            <h4 class="bracket-sub-header">üîµ Winners Bracket</h4>
            {% for round_name, matches in bracket_data.winners_bracket.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.is_bye %}bye-item{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') and not match.is_bye %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
                {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
            </div>
            {% endfor %}
            {% endfor %}

            {% if bracket_data.losers_bracket %}
            <h4 class="bracket-sub-header">üî¥ Losers Bracket</h4>
            {% for round_name, matches in bracket_data.losers_bracket.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endfor %}
            {% endif %}

            {% if bracket_data.grand_final %}
            <h4 class="bracket-sub-header">üèÜ Grand Final</h4>
            <div class="match-list-item grand-final-item {% if bracket_data.grand_final.get('winner') %}match-completed{% endif %}" data-teams="{{ bracket_data.grand_final.teams[0] }} {{ bracket_data.grand_final.teams[1] }}">
                <div class="match-list-meta">
                    <span>Grand Final</span>
                    {% if bracket_data.grand_final.get('winner') %}<span>‚úì</span>
                    {% elif bracket_data.grand_final.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[0] %}winner{% endif %}">{{ bracket_data.grand_final.teams[0] }}</span>
                    {% if bracket_data.grand_final.result and bracket_data.grand_final.result.sets %}
                    <span class="list-score">{{ bracket_data.grand_final.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if bracket_data.grand_final.winner == bracket_data.grand_final.teams[1] %}winner{% endif %}">{{ bracket_data.grand_final.teams[1] }}</span>
                    {% if bracket_data.grand_final.result and bracket_data.grand_final.result.sets %}
                    <span class="list-score">{{ bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>

            {% if bracket_data.bracket_reset and bracket_data.bracket_reset.get('needs_reset') %}
            <div class="match-list-item grand-final-item {% if bracket_data.bracket_reset.get('winner') %}match-completed{% endif %}" data-teams="{{ bracket_data.bracket_reset.teams[0] }} {{ bracket_data.bracket_reset.teams[1] }}">
                <div class="match-list-meta">
                    <span>Bracket Reset</span>
                    {% if bracket_data.bracket_reset.get('winner') %}<span>‚úì</span>
                    {% elif bracket_data.bracket_reset.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[0] %}winner{% endif %}">{{ bracket_data.bracket_reset.teams[0] }}</span>
                    {% if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets %}
                    <span class="list-score">{{ bracket_data.bracket_reset.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if bracket_data.bracket_reset.winner == bracket_data.bracket_reset.teams[1] %}winner{% endif %}">{{ bracket_data.bracket_reset.teams[1] }}</span>
                    {% if bracket_data.bracket_reset.result and bracket_data.bracket_reset.result.sets %}
                    <span class="list-score">{{ bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        {% elif bracket_data.rounds %}
            {# Single Elimination Format #}
            {% for round_name, matches in bracket_data.rounds.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.is_bye %}bye-item{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') and not match.is_bye %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
                {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
            </div>
            {% endfor %}
            {% endfor %}
        {% endif %}
    </div>
</details>
{% endif %}

{# ============ SILVER BRACKET (collapsed) ============ #}
{% if silver_bracket_enabled and silver_bracket_data %}
<details class="drill-down-section">
    <summary>ü•à Silver Bracket</summary>
    <div class="drill-down-content">
        {# Check if this is double elimination (has winners_bracket) or single elimination (has rounds) #}
        {% if silver_bracket_data.winners_bracket %}
            {# Double Elimination Silver Bracket #}
            <h4 class="bracket-sub-header">ü•à Winners Bracket</h4>
            {% for round_name, matches in silver_bracket_data.winners_bracket.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.is_bye %}bye-item{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') and not match.is_bye %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
                {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
            </div>
            {% endfor %}
            {% endfor %}

            {% if silver_bracket_data.losers_bracket %}
            <h4 class="bracket-sub-header">ü•à Losers Bracket</h4>
            {% for round_name, matches in silver_bracket_data.losers_bracket.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">{{ match.teams[0] }}</span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">{{ match.teams[1] }}</span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endfor %}
            {% endif %}

            {% if silver_bracket_data.grand_final %}
            <h4 class="bracket-sub-header">ü•à Silver Grand Final</h4>
            <div class="match-list-item grand-final-item {% if silver_bracket_data.grand_final.get('winner') %}match-completed{% endif %}" data-teams="{{ silver_bracket_data.grand_final.teams[0] }} {{ silver_bracket_data.grand_final.teams[1] }}">
                <div class="match-list-meta">
                    <span>Silver Grand Final</span>
                    {% if silver_bracket_data.grand_final.get('winner') %}<span>‚úì</span>
                    {% elif silver_bracket_data.grand_final.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[0] %}winner{% endif %}">{{ silver_bracket_data.grand_final.teams[0] }}</span>
                    {% if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets %}
                    <span class="list-score">{{ silver_bracket_data.grand_final.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if silver_bracket_data.grand_final.winner == silver_bracket_data.grand_final.teams[1] %}winner{% endif %}">{{ silver_bracket_data.grand_final.teams[1] }}</span>
                    {% if silver_bracket_data.grand_final.result and silver_bracket_data.grand_final.result.sets %}
                    <span class="list-score">{{ silver_bracket_data.grand_final.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>

            {% if silver_bracket_data.bracket_reset and silver_bracket_data.bracket_reset.get('needs_reset') %}
            <div class="match-list-item grand-final-item {% if silver_bracket_data.bracket_reset.get('winner') %}match-completed{% endif %}" data-teams="{{ silver_bracket_data.bracket_reset.teams[0] }} {{ silver_bracket_data.bracket_reset.teams[1] }}">
                <div class="match-list-meta">
                    <span>Silver Bracket Reset</span>
                    {% if silver_bracket_data.bracket_reset.get('winner') %}<span>‚úì</span>
                    {% elif silver_bracket_data.bracket_reset.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[0] %}winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[0] }}</span>
                    {% if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets %}
                    <span class="list-score">{{ silver_bracket_data.bracket_reset.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if silver_bracket_data.bracket_reset.winner == silver_bracket_data.bracket_reset.teams[1] %}winner{% endif %}">{{ silver_bracket_data.bracket_reset.teams[1] }}</span>
                    {% if silver_bracket_data.bracket_reset.result and silver_bracket_data.bracket_reset.result.sets %}
                    <span class="list-score">{{ silver_bracket_data.bracket_reset.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}
        {% elif silver_bracket_data.rounds %}
            {# Single Elimination Silver Bracket #}
            {% for round_name, matches in silver_bracket_data.rounds.items() %}
            <div class="bracket-round-label">{{ round_name }}</div>
            {% for match in matches %}
            <div class="match-list-item {% if match.is_bye %}bye-item{% endif %} {% if match.get('is_placeholder') %}match-placeholder{% endif %} {% if match.get('winner') and not match.is_bye %}match-completed{% endif %}" data-teams="{{ match.teams[0] }} {{ match.teams[1] }}">
                <div class="match-list-meta">
                    <span class="match-code-label">{{ match.match_code }}</span>
                    {% if match.get('winner') and not match.is_bye %}<span>‚úì</span>
                    {% elif match.get('is_playable') %}<span>üü¢</span>{% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[0] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[0] }}) {% endif %}{{ match.teams[0] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('first') | join('-') }}</span>
                    {% endif %}
                </div>
                <div class="match-list-row">
                    <span class="team-name {% if match.winner == match.teams[1] %}winner{% endif %}">
                        {% if match.seeds %}({{ match.seeds[1] }}) {% endif %}{{ match.teams[1] }}
                    </span>
                    {% if match.result and match.result.sets %}
                    <span class="list-score">{{ match.result.sets | map('last') | join('-') }}</span>
                    {% endif %}
                </div>
                {% if match.is_bye %}<div class="bye-label">BYE</div>{% endif %}
            </div>
            {% endfor %}
            {% endfor %}
        {% endif %}
    </div>
</details>
{% endif %}

{# ============ AWARDS (collapsed) ============ #}
{% if awards %}
<details class="drill-down-section">
    <summary>üèÜ Awards</summary>
    <div class="drill-down-content">
        <div class="awards-grid">
            {% for award in awards %}
            <div class="award-card">
                {% if award.image %}
                    {% if award.image.startswith('custom-') %}
                    <img src="{{ url_for('api_awards_image', filename=award.image) }}" alt="{{ award.name }}" class="award-card-img">
                    {% else %}
                    <img src="{{ url_for('static', filename='awards/' ~ award.image) }}" alt="{{ award.name }}" class="award-card-img">
                    {% endif %}
                {% endif %}
                <div class="award-card-info">
                    <strong>{{ award.name }}</strong>
                    <span>{{ award.player }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</details>
{% endif %}

{# ============ MESSAGE ORGANIZERS ============ #}
<details class="drill-down-section message-organizers-section">
    <summary>üì® Message Organizers</summary>
    <div class="drill-down-content">
        <form id="message-form" class="message-form" onsubmit="return sendMessage(event)">
            <div class="form-group">
                <label for="message-team">Your Team:</label>
                <select id="message-team" name="team_name" required>
                    <option value="">Select your team...</option>
                    {% for pool_name, pool_data in pools.items() %}
                        {% for team in pool_data.teams %}
                            <option value="{{ team }}">{{ team }}</option>
                        {% endfor %}
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="message-text">Message:</label>
                <textarea id="message-text" name="message" rows="4" maxlength="500" 
                          placeholder="Ask a question, report an issue..." required></textarea>
                <div class="char-count"><span id="char-count">0</span>/500</div>
            </div>
            <button type="submit" class="btn btn-primary">Send Message</button>
            <div id="message-feedback" class="message-feedback" style="display:none;"></div>
        </form>
    </div>
</details>

{% endif %}{# end pools #}

<script>
// Player Score Reporting
(function() {
    var scoringFormat = {{ ('\"' + constraints.get('scoring_format', 'best_of_3') + '\"') | safe }};
    {% if public_mode %}
    var reportApiUrl = '/api/report-result/{{ public_username }}/{{ public_slug }}';
    {% else %}
    var reportApiUrl = '/api/report-result';
    {% endif %}

    // LocalStorage key for tracking submitted reports
    function getStorageKey() {
        {% if public_mode %}
        return 'pending_results_{{ public_username }}_{{ public_slug }}';
        {% else %}
        return 'pending_results_' + (window.location.pathname.split('/').slice(-2).join('_'));
        {% endif %}
    }

    // Check if match already reported
    function isAlreadyReported(matchKey) {
        var key = getStorageKey();
        var submitted = JSON.parse(localStorage.getItem(key) || '[]');
        return submitted.indexOf(matchKey) !== -1;
    }

    // Mark match as reported
    function markAsReported(matchKey) {
        var key = getStorageKey();
        var submitted = JSON.parse(localStorage.getItem(key) || '[]');
        if (submitted.indexOf(matchKey) === -1) {
            submitted.push(matchKey);
            localStorage.setItem(key, JSON.stringify(submitted));
        }
    }

    window.toggleReportForm = function(btn) {
        var matchItem = btn.closest('.match-list-item, .hero-match-card');
        var matchKey = matchItem.dataset.matchCode || matchItem.dataset.matchKey;
        
        // Check if form already exists
        var existingForm = matchItem.querySelector('.report-score-form');
        if (existingForm) {
            existingForm.remove();
            return;
        }

        // Build form
        var team1 = matchItem.dataset.team1;
        var team2 = matchItem.dataset.team2;
        var pool = matchItem.dataset.pool;
        
        var numSets = scoringFormat === 'single_set' ? 1 : 3;
        var formHtml = '<div class="report-score-form">';
        formHtml += '<div class="report-form-header">Report Score</div>';
        
        // Team 1 row
        formHtml += '<div class="report-form-row">';
        formHtml += '<span class="report-team-name">' + team1 + '</span>';
        formHtml += '<div class="report-score-inputs">';
        for (var i = 0; i < numSets; i++) {
            formHtml += '<input type="number" class="report-score-input" data-team="0" data-set="' + i + '" min="0" max="99" inputmode="numeric" placeholder="-">';
        }
        formHtml += '</div></div>';
        
        // Team 2 row
        formHtml += '<div class="report-form-row">';
        formHtml += '<span class="report-team-name">' + team2 + '</span>';
        formHtml += '<div class="report-score-inputs">';
        for (var i = 0; i < numSets; i++) {
            formHtml += '<input type="number" class="report-score-input" data-team="1" data-set="' + i + '" min="0" max="99" inputmode="numeric" placeholder="-">';
        }
        formHtml += '</div></div>';
        
        formHtml += '<div class="report-form-actions">';
        formHtml += '<button class="btn-report-submit" onclick="submitReport(this)">Submit</button>';
        formHtml += '<button class="btn-report-cancel" onclick="cancelReport(this)">Cancel</button>';
        formHtml += '</div></div>';
        
        matchItem.insertAdjacentHTML('beforeend', formHtml);
    };

    window.submitReport = function(btn) {
        var form = btn.closest('.report-score-form');
        var matchItem = form.closest('.match-list-item, .hero-match-card');
        // For bracket matches, prefer the explicit match_code over the general match_key
        var matchKey = matchItem.dataset.matchCode || matchItem.dataset.matchKey;
        var team1 = matchItem.dataset.team1;
        var team2 = matchItem.dataset.team2;
        var pool = matchItem.dataset.pool;
        
        // Collect scores
        var inputs = form.querySelectorAll('.report-score-input');
        var sets = [];
        var numSets = scoringFormat === 'single_set' ? 1 : 3;
        
        for (var i = 0; i < numSets; i++) {
            var t1Input = form.querySelector('[data-team="0"][data-set="' + i + '"]');
            var t2Input = form.querySelector('[data-team="1"][data-set="' + i + '"]');
            var score1 = t1Input.value ? parseInt(t1Input.value) : null;
            var score2 = t2Input.value ? parseInt(t2Input.value) : null;
            
            if (score1 !== null && score2 !== null) {
                sets.push([score1, score2]);
            }
        }
        
        if (sets.length === 0) {
            console.warn('Score submission validation failed: no sets entered');
            return;
        }
        
        // Send to server
        var payload = {
            match_key: matchKey,
            team1: team1,
            team2: team2,
            pool: pool,
            sets: sets
        };
        
        fetch(reportApiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                form.remove();
            } else {
                console.error('Score submission error:', data.error);
            }
        })
        .catch(function(err) {
            console.error('Failed to submit report:', err);
        });
    };

    window.cancelReport = function(btn) {
        var form = btn.closest('.report-score-form');
        form.remove();
    };

    // Message Form Handlers
    var messageTextarea = document.getElementById('message-text');
    if (messageTextarea) {
        messageTextarea.addEventListener('input', function() {
            document.getElementById('char-count').textContent = this.value.length;
        });
    }

    window.sendMessage = function(event) {
        event.preventDefault();
        
        var form = event.target;
        var teamName = form.querySelector('[name="team_name"]').value.trim();
        var message = form.querySelector('[name="message"]').value.trim();
        var feedback = document.getElementById('message-feedback');
        
        if (!teamName || !message) {
            feedback.textContent = 'Please fill in all fields.';
            feedback.className = 'message-feedback error';
            feedback.style.display = 'block';
            return false;
        }
        
        if (message.length > 500) {
            feedback.textContent = 'Message is too long (max 500 characters).';
            feedback.className = 'message-feedback error';
            feedback.style.display = 'block';
            return false;
        }
        
        {% if public_mode %}
        var messageApiUrl = '/api/message/{{ public_username }}/{{ public_slug }}';
        {% else %}
        var messageApiUrl = '/api/message';
        {% endif %}
        
        fetch(messageApiUrl, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({team_name: teamName, message: message})
        })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                feedback.textContent = 'Message sent successfully!';
                feedback.className = 'message-feedback success';
                feedback.style.display = 'block';
                form.reset();
                document.getElementById('char-count').textContent = '0';
                setTimeout(function() {
                    feedback.style.display = 'none';
                }, 5000);
            } else {
                feedback.textContent = data.error || 'Failed to send message.';
                feedback.className = 'message-feedback error';
                feedback.style.display = 'block';
            }
        })
        .catch(function(err) {
            console.error('Failed to send message:', err);
            feedback.textContent = 'Failed to send message. Please try again.';
            feedback.className = 'message-feedback error';
            feedback.style.display = 'block';
        });
        
        return false;
    };
})();
</script>
