{% extends "base.html" %}

{% block title %}Tournaments - Tournament Allocator{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Tournament Management</h1>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<section class="section">
    <h2>Create New Tournament</h2>
    <form method="POST" action="{{ url_for('api_create_tournament') }}" class="inline-form">
        <input type="text" name="name" placeholder="Tournament name" required>
        <button type="submit" class="btn btn-primary">Create</button>
    </form>
</section>

<section class="section">
    <h2>Your Tournaments</h2>
    {% if tournaments %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for t in tournaments %}
            <tr class="{% if t.slug == active %}active-tournament{% endif %}">
                <td>
                    {{ t.name }}
                    {% if t.slug == active %} <span class="badge badge-active">Active</span>{% endif %}
                </td>
                <td>{{ t.created[:10] if t.created else '‚Äî' }}</td>
                <td>
                    <div class="tournament-actions">
                        <div class="tournament-action-slot">
                            {% if t.slug != active %}
                            <form method="POST" action="{{ url_for('api_switch_tournament') }}" class="inline">
                                <input type="hidden" name="slug" value="{{ t.slug }}">
                                <button type="submit" class="btn btn-success btn-sm">Switch</button>
                            </form>
                            {% endif %}
                        </div>
                        <form method="POST" action="{{ url_for('api_clone_tournament') }}" class="inline"
                              onsubmit="return cloneTournament(this, '{{ t.name }}')">
                            <input type="hidden" name="slug" value="{{ t.slug }}">
                            <input type="hidden" name="name" value="">
                            <button type="submit" class="btn btn-primary btn-sm">Clone</button>
                        </form>
                        <form method="POST" action="{{ url_for('api_delete_tournament') }}" class="inline"
                              onsubmit="return confirm('Delete tournament &quot;{{ t.name }}&quot;? This cannot be undone.')">
                            <input type="hidden" name="slug" value="{{ t.slug }}">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h2>No tournaments yet</h2>
        <p>Create one above to get started.</p>
    </div>
    {% endif %}
</section>

<section class="section">
    <h2>Backup & Restore</h2>
    <div class="actions-bar" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="{{ url_for('api_export_user') }}" class="btn btn-secondary btn-sm">üíæ Export All Tournaments</a>
        <button onclick="document.getElementById('import-all-file').click()" class="btn btn-secondary btn-sm">üìÇ Import Tournaments</button>
    </div>
    <form id="import-all-form" method="POST" action="{{ url_for('api_import_user') }}" enctype="multipart/form-data" style="display:none">
        <input type="file" id="import-all-file" name="file" accept=".zip" onchange="confirmImport(this)">
    </form>
</section>

{% if current_user == 'admin' %}
<section class="section section-danger-zone">
    <h2>üîí Site Administration (Admin Only)</h2>
    <p style="margin-bottom: 0.75rem; color: var(--text-muted);">These actions affect <strong>all users and all tournaments</strong> on this site.</p>
    <div class="actions-bar" style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
        <a href="{{ url_for('api_export_site') }}" class="btn btn-secondary btn-sm">üíæ Export Site Backup</a>
        <button onclick="document.getElementById('import-site-file').click()" class="btn btn-danger btn-sm">üìÇ Import Site Backup</button>
    </div>
    <div class="alert alert-error" style="margin-top: 0.75rem;">
        ‚ö†Ô∏è <strong>Import warning:</strong> Importing a site backup will <strong>REPLACE ALL data</strong> on this site (all users, all tournaments). This cannot be undone.
    </div>
    <form id="import-site-form" method="POST" action="{{ url_for('api_import_site') }}" enctype="multipart/form-data" style="display:none">
        <input type="file" id="import-site-file" name="file" accept=".zip" onchange="confirmSiteImport(this)">
    </form>
</section>
{% endif %}

<script>
function cloneTournament(form, originalName) {
    var newName = prompt('Enter a name for the cloned tournament:', originalName + ' (Copy)');
    if (!newName || !newName.trim()) return false;
    form.querySelector('input[name="name"]').value = newName.trim();
    return true;
}

function confirmImport(input) {
    if (!input.files.length) return;
    if (confirm('This will import tournaments from the ZIP file. Existing tournaments with the same name will be overwritten. Continue?')) {
        document.getElementById('import-all-form').submit();
    } else {
        input.value = '';
    }
}

function confirmSiteImport(input) {
    if (!input.files.length) return;
    var typed = prompt('This will REPLACE ALL data on the site (all users, all tournaments). This cannot be undone.\n\nType REPLACE to confirm:');
    if (typed === 'REPLACE') {
        document.getElementById('import-site-form').submit();
    } else {
        input.value = '';
        if (typed !== null) {
            alert('Import cancelled ‚Äî you must type exactly "REPLACE" to proceed.');
        }
    }
}
</script>
{% endblock %}
